<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Organization - CSC Institution Management</title>
    <link rel="icon" type="image/png" href="https://images.squarespace-cdn.com/content/v1/5ec55d5d28a93e0e18d2eeb4/1600096854522-HS7NUI12I1ML6SPJFLLY/Artboard+1.png?format=1500w">

    <!-- External Fonts -->
    <link rel="stylesheet" href="https://use.typekit.net/ilr6ctr.css">

    <!-- YOUR CUSTOM STYLESHEET -->
    <link rel="stylesheet" href="institution-management.css">

    <!-- Conference Attendance Breakdown Styles -->
    <style>
        .conference-attendance-breakdown {
            margin-top: 1.5em;
            padding: 1em;
            background: #f8f9fa;
            border-radius: 0.5em;
            border-left: 4px solid #007bff;
        }

        .breakdown-header {
            font-weight: bold;
            margin-bottom: 0.8em;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .breakdown-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5em;
            padding: 0.3em 0;
        }

        .breakdown-item.free {
            opacity: 0.8;
        }

        .breakdown-item.paid {
            font-weight: 500;
        }

        .attendee-icon {
            margin-right: 0.5em;
            font-size: 1.1em;
        }

        .attendee-name {
            font-weight: 500;
            margin-right: 0.8em;
            min-width: 120px;
        }

        .attendee-reason {
            color: #6c757d;
            font-size: 0.9em;
        }

        .breakdown-item.paid .attendee-reason {
            color: #28a745;
            font-weight: 500;
        }

        .invoice-preview-note {
            font-size: 0.8em;
            color: #666;
            font-style: italic;
            margin-top: 5px;
        }

        .invoice-container .csc-logo img {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }

        .already-renewed-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .already-renewed-content {
            background: white;
            border-radius: 12px;
            padding: 2.5em;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .already-renewed-icon {
            font-size: 4em;
            margin-bottom: 0.5em;
        }

        .already-renewed-content h2 {
            color: #2c3e50;
            margin-bottom: 1em;
            font-family: 'davis-sans', sans-serif;
        }

        .already-renewed-content p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 1.5em;
        }

        .already-renewed-content a {
            color: #0071bc;
            text-decoration: none;
        }

        .already-renewed-content a:hover {
            text-decoration: underline;
        }

        .already-renewed-options {
            display: flex;
            flex-direction: column;
            gap: 1em;
            margin-top: 2em;
        }

        .option-btn {
            padding: 1em 1.5em;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .option-btn.primary {
            background: #0071bc;
            color: white;
        }

        .option-btn.primary:hover {
            background: #005a94;
            text-decoration: none;
        }

        .option-btn.secondary {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .option-btn small {
            display: block;
            font-size: 0.8em;
            margin-top: 0.25em;
        }
    </style>
</head>
<body>
    <div class="wizard-container">
        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="loading-title">
                Loading<span class="dots">
                    <span class="dot">.</span>
                    <span class="dot">.</span>
                    <span class="dot">.</span>
                </span>
            </div>
        </div>

        <!-- Upload Animation State -->
        <div class="uploading-state" id="uploadingState">
            <div class="uploading-title">
                Uploading<span class="dots">
                    <span class="dot">.</span>
                    <span class="dot">.</span>
                    <span class="dot">.</span>
                </span>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="error">
            <strong>Oops!</strong> <span id="errorMessage"></span>
        </div>

        <!-- Success State -->
        <div id="successState" class="success">
            <h3>‚úÖ Membership Renewal Complete!</h3>
            <p>Thank you for renewing your CSC membership. Your payment has been processed and your membership is now active for the 2025-2026 year.</p>
        </div>

        <!-- Already Renewed Overlay -->
        <div id="alreadyRenewedOverlay" class="already-renewed-overlay" style="display: none;">
            <div class="already-renewed-content">
                <div class="already-renewed-icon">üîí</div>
                <h2>Membership Already Current</h2>
                <p>Hey, we see you but we think that you've already completed this process and the payment has been applied to your account. Thanks for doing that.</p>

                <p>If this is an error on our part, get in contact with <a href="mailto:google@campusstores.ca">Steve Thomas</a>.</p>

                <div class="already-renewed-options">
                    <a href="https://campusstores.events/conference-26/delegate-registration" target="_blank" class="option-btn primary">
                        üé™ Conference Registration
                    </a>
                    <button class="option-btn secondary" disabled>
                        ‚úèÔ∏è Edit Organization Details<br>
                        <small>Coming Soon</small>
                    </button>
                </div>
            </div>
        </div>

        <!-- All Content - Hidden until loaded -->
        <div class="wizard-content" id="wizardContent">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="logo-section">
                    <div class="logo-container">
                        <img src="https://images.squarespace-cdn.com/content/v1/5ec55d5d28a93e0e18d2eeb4/1600096854522-HS7NUI12I1ML6SPJFLLY/Artboard+1.png?format=1500w" alt="Campus Stores Canada" class="csc-logo">
                        <div id="organizationLogo" class="organization-logo-container"></div>
                    </div>
                </div>

                <div class="step-navigation">
                    <div class="step-item" data-step="0">
                        <div class="step-number">
                            üë§
                        </div>
                        <div class="step-title">My Profile</div>
                    </div>
                    <div class="step-item" data-step="1">
                        <div class="step-number">
                            üë•
                        </div>
                        <div class="step-title">My Team</div>
                    </div>

                </div>
            </div>
            <!-- Main Content -->
            <div class="main-content">
                <!-- Mobile Progress Bar -->
                <div class="mobile-progress">
                    <div class="mobile-progress-fill" style="width: 0%"></div>
                </div>

                <!-- Welcome Screen -->
                <div id="welcomeSection" class="content-section active">
                    <div class="welcome-container">
                        <div class="welcome-section">
                            <h1 class="welcome-title">Welcome to CSC Membership Renewal!</h1>
                            <p class="welcome-text">
                                Thank you for renewing your Campus Stores Canada membership for the 2025-26 year.
                            </p>
                            <p class="welcome-text">
                                We'll guide you through updating your institution information, managing your team contacts, setting up billing preferences, and completing your payment.
                            </p>
                            <p class="welcome-text">
                                This process should take just a few minutes, and you can save your progress at any time. Let's get started!
                            </p>
                            <button class="get-started-btn" onclick="startWizard()">
                                Get started <span>‚Üí</span>
                            </button>
                        </div>
                        
                    </div>
                </div>

                <!-- Step 1: Company Information -->
                <div id="step1Section" class="content-section">
                    <div class="step-header">
                        <h2 class="step-title-main">Institution Information</h2>
                        <p class="step-subtitle">Please verify and update your institution's membership details:</p>
                    </div>

                    <div class="form-container">
                        <!-- Institution Name Field -->
                        <div class="form-field" data-field="institutionName">
                            <div class="field-display" id="institutionNameDisplay">Loading...</div>
                            <button class="edit-btn" onclick="editField('institutionName')" id="editInstitutionName">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="m18 2 4 4-14 14H4v-4L18 2z"/>
                                    <path d="m14.5 5.5 4 4"/>
                                </svg>
                            </button>
                        </div>

                        <!-- Institution Website Field -->
                        <div class="form-field" data-field="website">
                            <div class="field-display" id="websiteDisplay">Institution website (university.ca)</div>
                            <button class="edit-btn" onclick="editField('website')" id="editWebsite">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="m18 2 4 4-14 14H4v-4L18 2z"/>
                                    <path d="m14.5 5.5 4 4"/>
                                </svg>
                            </button>
                        </div>


                        <!-- Institution Size Field -->
                        <div class="form-field" data-field="institutionSize">
                            <div class="custom-dropdown" id="institutionSizeDropdown">
                                <div class="dropdown-display" id="institutionSizeDisplay">
                                    <span id="institutionSizeText">Select institution size</span>
                                    <svg class="dropdown-arrow" viewBox="0 0 19.87 12.22">
                                        <path d="M19.68.11c-.21-.17-.52-.15-.7.07l-9.03,10.77-.02-.02-.02.02L.88.18C.7-.04.39-.06.18.11-.04.29-.06.61.11.82l9.42,11.22c.1.12.24.18.38.18h.04c.14,0,.28-.06.38-.18L19.75.82c.17-.21.15-.53-.07-.71Z" fill="#999999"/>
                                    </svg>
                                </div>
                                <div class="dropdown-options" id="institutionSizeOptions" style="display: none;">
                                    <!-- Options will be populated dynamically -->
                                </div>
                            </div>
                        </div>

                        <!-- Address Block -->
                        <div class="form-field" data-field="address">
                            <div class="field-display address-block" id="addressDisplay">
                                <div class="address-line-1" id="addressLine1">Street address</div>
                                <div class="address-line-2" id="addressLine2">
                                    <span id="cityPart">City</span>, <span id="provincePart">Province</span> <span id="postalCodePart">Postal Code</span>
                                </div>
                            </div>
                            <button class="edit-btn" onclick="editField('address')" id="editAddress">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="m18 2 4 4-14 14H4v-4L18 2z"/>
                                    <path d="m14.5 5.5 4 4"/>
                                </svg>
                            </button>
                        </div>

                        <!-- Divider -->
                        <div style="border-top: 2px solid #eee; margin: 40px 0 30px 0;"></div>

                        <!-- Section Header: Your Contact Information -->
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #333; font-size: 18px; font-weight: 600; margin-bottom: 8px;">Your Contact Information</h3>
                            <p style="color: #666; font-size: 14px;">This information is always editable by you.</p>
                        </div>

                        <!-- User Name Field -->
                        <div class="form-field" data-field="userName">
                            <div class="field-display" id="userNameDisplay">Loading...</div>
                            <button class="edit-btn" onclick="editField('userName')" id="editUserName">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="m18 2 4 4-14 14H4v-4L18 2z"/>
                                    <path d="m14.5 5.5 4 4"/>
                                </svg>
                            </button>
                        </div>

                        <!-- User Email Field -->
                        <div class="form-field" data-field="userEmail">
                            <div class="field-display" id="userEmailDisplay">Loading...</div>
                            <button class="edit-btn" onclick="editField('userEmail')" id="editUserEmail">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="m18 2 4 4-14 14H4v-4L18 2z"/>
                                    <path d="m14.5 5.5 4 4"/>
                                </svg>
                            </button>
                        </div>

                        <!-- User Phone Field -->
                        <div class="form-field" data-field="userPhone">
                            <div class="field-display" id="userPhoneDisplay">Phone number</div>
                            <button class="edit-btn" onclick="editField('userPhone')" id="editUserPhone">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="m18 2 4 4-14 14H4v-4L18 2z"/>
                                    <path d="m14.5 5.5 4 4"/>
                                </svg>
                            </button>
                        </div>

                        <!-- User Title Field -->
                        <div class="form-field" data-field="userTitle">
                            <div class="field-display" id="userTitleDisplay">Job title</div>
                            <button class="edit-btn" onclick="editField('userTitle')" id="editUserTitle">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="m18 2 4 4-14 14H4v-4L18 2z"/>
                                    <path d="m14.5 5.5 4 4"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <button class="previous-btn" onclick="previousStep()">
                        <span>‚Üê</span>
                        Previous step
                    </button>
                    <button class="next-btn" onclick="nextStep()">
                        Next step
                        <span>‚Üí</span>
                    </button>
                </div>

                <!-- Step 2: My Team -->
                <div id="step2Section" class="content-section">
                    <div class="step-header">
                        <h2 class="step-title-main">My Team</h2>
                        <p class="step-subtitle">Manage your team members and update conference attendance. You can edit contact details based on your permissions, and indicate who is attending the conference.</p>
                    </div>

                    <div class="team-container">
                        <div class="team-list-wrapper">
                            <div class="team-list" id="teamList">
                                <!-- Contacts will be dynamically added here -->
                            </div>
                            <div class="team-list-fade"></div>
                            <div class="team-list-shadow"></div>
                            <div class="custom-scrollbar" id="teamScrollbar">
                                <div class="scrollbar-track">
                                    <div class="scrollbar-thumb" id="scrollbarThumb"></div>
                                </div>
                            </div>
                        </div>

                        <div class="add-contact-section">
                            <div class="add-contact-item" id="addContactItem">
                                <div class="contact-checkbox">
                                    <div class="checkbox-circle"></div>
                                </div>
                                <div class="contact-info">
                                    <div class="contact-name">A new contact</div>
                                    <div class="contact-details">You can add all the contacts our members should know, attending or not.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <button class="previous-btn" onclick="previousStep()">
                        <span>‚Üê</span>
                        Previous step
                    </button>
                    <button class="next-btn" onclick="nextStep()">
                        Next step
                        <span>‚Üí</span>
                    </button>
                </div>
                <!-- Crop Modal -->
                <div class="crop-modal" id="cropModal">
                    <div class="crop-container">
                        <div class="crop-header">
                            <div class="crop-title">Crop your image</div>
                            <div class="crop-subtitle">Adjust the image to fit a 9:16 aspect ratio (portrait)</div>
                        </div>
                        <div class="crop-image-container">
                            <img class="crop-image" id="cropImage" alt="Image to crop">
                        </div>
                        <div class="crop-actions">
                            <button class="crop-btn secondary" onclick="cancelCrop()">Cancel</button>
                            <button class="crop-btn primary" onclick="applyCrop()">Apply Crop</button>
                        </div>
                    </div>
                </div>
            </div>
    <script>
        // ===========================================
        // WIZARD STATE MANAGEMENT
        // ===========================================
        let currentStep = 0;
        const totalSteps = 6;
        let organizationData = {};
        let organizationContacts = [];
        let conferenceTeam = [];
        let categoryDropdownOpen = false;
        let activeField = null;
        let formState = {
            // Step 1
            companyName: '',
            website: '',
            category: '',
            description: '',
            // Step 2
            highlightHeadline: '',
            highlightDescription: '',
            highlightDeal: '',
            highlightImageUrl: ''
        };
        
        const API_BASE = '/api';
        
        // ===========================================
        // CROPPER MANAGEMENT
        // ===========================================
        let cropperInstance = null;
        let currentFile = null;
        let initializedSteps = new Set();

        // ===========================================
        // HANDLE ORIENTATION CHANGES
        // ===========================================
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                initialViewportHeight = window.innerHeight;
            }, 500);
        });
        
        // ===========================================
        // MOBILE INITIALIZATION
        // ===========================================
        
        
        document.addEventListener('DOMContentLoaded', () => {
            // Get started button handler
            const mobileGetStartedBtn = document.getElementById('mobileGetStartedBtn');
            if (mobileGetStartedBtn) {
                mobileGetStartedBtn.addEventListener('click', startWizard);
            }
            
            // Previous button handler
            const mobilePrevBtn = document.getElementById('mobilePrevBtn');
            if (mobilePrevBtn) {
                mobilePrevBtn.addEventListener('click', previousStep);
            }
            
            // Next button handler (handles both next and finish)
            const mobileNextBtn = document.getElementById('mobileNextBtn');
            if (mobileNextBtn) {
                mobileNextBtn.addEventListener('click', () => {
                    if (currentStep === 5) {
                        finishWizard();
                    } else {
                        nextStep();
                    }
                });
            }
        });
        
        // ===========================================
        // MOBILE ENHANCEMENTS
        // ===========================================
        
        // Prevent zoom on input focus for iOS
        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
            const viewportMeta = document.querySelector('meta[name="viewport"]');
            viewportMeta.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
        }

        // Handle orientation changes
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                initialViewportHeight = window.innerHeight;
                isMobile = window.innerWidth <= 768;

                
                // Call your existing updateMobileProgress function if it exists
                if (typeof updateMobileProgress === 'function') {
                    updateMobileProgress();
                }
                
                // Force layout recalculation
                document.body.style.height = '100vh';
                setTimeout(() => {
                    document.body.style.height = 'auto';
                }, 100);
            }, 500);
        });

        // Improve touch scrolling on mobile
        if ('ontouchstart' in window) {
            document.addEventListener('touchstart', () => {}, { passive: true });
            document.addEventListener('touchmove', () => {}, { passive: true });
        }

        // Add scroll-to-top for mobile navigation
        function addMobileScrollToTop() {
            if (window.innerWidth <= 768) {
                window.scrollTo(0, 0);
            }
        }
        
        console.log('üì± Mobile-optimized vendor profile wizard loaded!');

        // ===========================================
        // GLOBAL ESC KEY HANDLER
        // ===========================================

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Close modals first (highest priority)
                const contactModal = document.getElementById('contactModal');
                const invoiceModal = document.getElementById('invoiceModal');
                const cropModal = document.getElementById('cropModal');

                if (contactModal && contactModal.classList.contains('active')) {
                    cancelContactModal();
                    return;
                }

                if (invoiceModal) {
                    closeInvoiceModal();
                    return;
                }

                if (cropModal && cropModal.style.display === 'flex') {
                    cancelCrop();
                    return;
                }

                // Close any open dropdowns
                const openDropdowns = document.querySelectorAll('.dropdown-options[style*="block"]');
                openDropdowns.forEach(dropdown => {
                    dropdown.style.display = 'none';
                    const dropdownDisplay = dropdown.parentElement.querySelector('.dropdown-display');
                    if (dropdownDisplay) {
                        dropdownDisplay.classList.remove('open');
                    }
                });

                // If any dropdowns were closed, blur focus
                if (openDropdowns.length > 0) {
                    document.activeElement.blur();
                }

                console.log('üîê ESC pressed - closed modals/dropdowns');
            }
        });

        // ===========================================
        // CUSTOM DROPDOWN FUNCTIONALITY - Updated for membership renewal
        // ===========================================
        function initializeDropdown() {
            console.log('üîß Initializing dropdowns...');

            // Try category dropdown first (legacy)
            const categoryDropdown = document.getElementById('categoryDropdown');
            const categoryDisplay = document.getElementById('categoryDisplay');
            const categoryOptions = document.getElementById('categoryOptions');
            const categoryText = document.getElementById('categoryText');

            // Try institution size dropdown
            const sizeDropdown = document.getElementById('institutionSizeDropdown');
            const sizeDisplay = document.getElementById('institutionSizeDisplay');
            const sizeOptions = document.getElementById('institutionSizeOptions');
            const sizeText = document.getElementById('institutionSizeText');

            // Try province dropdown
            const provinceDropdown = document.getElementById('provinceDropdown');
            const provinceDisplay = document.getElementById('provinceDisplay');
            const provinceOptionsElement = document.getElementById('provinceOptions');
            const provinceTextElement = document.getElementById('provinceText');

            // Initialize category dropdown if it exists
            if (categoryDropdown && categoryDisplay && categoryOptions && categoryText) {
                console.log('‚úÖ Initializing category dropdown');
                initializeSpecificDropdown(categoryDropdown, categoryDisplay, categoryOptions, categoryText, 'category');
            }

            // Initialize institution size dropdown if it exists
            if (sizeDropdown && sizeDisplay && sizeOptions && sizeText) {
                console.log('‚úÖ Initializing institution size dropdown');
                initializeSpecificDropdown(sizeDropdown, sizeDisplay, sizeOptions, sizeText, 'institutionSize');
            }

            // Initialize province dropdown if it exists
            if (provinceDropdown && provinceDisplay && provinceOptionsElement && provinceTextElement) {
                console.log('‚úÖ Initializing province dropdown');
                initializeSpecificDropdown(provinceDropdown, provinceDisplay, provinceOptionsElement, provinceTextElement, 'province');
            }
        }

        function initializeSpecificDropdown(dropdown, display, options, text, fieldType) {

            // Click on display to toggle dropdown
            display.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = options.style.display === 'block';
                
                if (isOpen) {
                    closeDropdown();
                } else {
                    openDropdown();
                }
            });
            
            // Click on options
            options.addEventListener('click', (e) => {
                if (e.target.classList.contains('dropdown-option')) {
                    const value = e.target.getAttribute('data-value');
                    selectOption(value);
                    closeDropdown();
                }
            });
            
            // Click outside to close
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target)) {
                    closeDropdown();
                }
            });
            
            function openDropdown() {
                options.style.display = 'block';
                display.classList.add('open');
                const currentValue = formState[fieldType];
                options.querySelectorAll('.dropdown-option').forEach(option => {
                    option.classList.remove('selected');
                    if (option.getAttribute('data-value') === currentValue) {
                        option.classList.add('selected');
                    }
                });
            }
            
            function closeDropdown() {
                options.style.display = 'none';
                display.classList.remove('open');
                // Dropdown closed
            }
            
            function selectOption(value) {
                formState[fieldType] = value;

                // For institution size, we need to show the label, not the value
                if (fieldType === 'institutionSize' || fieldType === 'billingDisplay' || fieldType === 'paymentMethod') {
                    const selectedOption = options.querySelector(`[data-value="${value}"]`);
                    if (selectedOption) {
                        text.textContent = selectedOption.textContent;
                    }
                } else {
                    text.textContent = value;
                }

                display.classList.remove('placeholder');
                console.log(`üìù Selected ${fieldType}:`, value);
            }
        }

        function initializeBillingDropdowns() {
            // Initialize billing display dropdown
            const billingDropdown = document.getElementById('billingDisplayDropdown');
            const billingDisplay = document.getElementById('billingDisplayDisplay');
            const billingOptions = document.getElementById('billingDisplayOptions');
            const billingText = document.getElementById('billingDisplayText');

            if (billingDropdown && billingDisplay && billingOptions && billingText) {
                console.log('‚úÖ Initializing billing display dropdown');
                initializeSpecificDropdown(billingDropdown, billingDisplay, billingOptions, billingText, 'billingDisplay');
            }

            // Initialize payment method dropdown
            const paymentDropdown = document.getElementById('paymentMethodDropdown');
            const paymentDisplay = document.getElementById('paymentMethodDisplay');
            const paymentOptions = document.getElementById('paymentMethodOptions');
            const paymentText = document.getElementById('paymentMethodText');

            if (paymentDropdown && paymentDisplay && paymentOptions && paymentText) {
                console.log('‚úÖ Initializing payment method dropdown');
                initializeSpecificDropdown(paymentDropdown, paymentDisplay, paymentOptions, paymentText, 'paymentMethod');
            }

            // Initialize invoice preview
            initializeInvoicePreview();
        }

        function initializeInvoicePreview() {
            // Update preview whenever relevant data changes
            updateInvoicePreview();

            // Set up listeners for real-time updates
            setupInvoicePreviewListeners();

            console.log('‚úÖ Invoice preview initialized');
        }

        function setupInvoicePreviewListeners() {
            // Listen for dropdown changes
            const originalSelectOption = window.selectOption;

            // Override the existing selectOption function to trigger preview updates
            // This will be called from within initializeSpecificDropdown
            const updatePreviewFields = ['institutionSize', 'billingDisplay'];

            // We'll add a global listener that watches for changes in form state
            const checkForUpdates = setInterval(() => {
                if (window.lastPreviewState !== JSON.stringify({
                    institutionSize: formState.institutionSize,
                    billingDisplay: formState.billingDisplay,
                    attendingCount: teamState.attendingContacts?.size || 0
                })) {
                    updateInvoicePreview();
                    window.lastPreviewState = JSON.stringify({
                        institutionSize: formState.institutionSize,
                        billingDisplay: formState.billingDisplay,
                        attendingCount: teamState.attendingContacts?.size || 0
                    });
                }
            }, 500);
        }

        function updateInvoicePreview() {
            const previewElement = document.querySelector('[data-field="invoicePreview"] .field-display');
            if (!previewElement) return;

            const preview = generateInvoicePreview();
            previewElement.innerHTML = preview;

            // Add click handler and hover effects to preview
            const invoicePreviewDiv = previewElement.querySelector('.invoice-preview');
            if (invoicePreviewDiv) {
                invoicePreviewDiv.onclick = openInvoiceModal;

                let hoverTimeout;
                const hoverOverlay = invoicePreviewDiv.querySelector('.hover-overlay');

                invoicePreviewDiv.addEventListener('mouseenter', () => {
                    hoverTimeout = setTimeout(() => {
                        if (hoverOverlay) {
                            hoverOverlay.style.opacity = '1';
                        }
                    }, 1000); // Show after 1 second
                });

                invoicePreviewDiv.addEventListener('mouseleave', () => {
                    clearTimeout(hoverTimeout);
                    if (hoverOverlay) {
                        hoverOverlay.style.opacity = '0';
                    }
                });
            }
        }

        function generateInvoicePreview() {
            // Pricing structure
            const membershipPricing = {
                'XSmall': 420,
                'Small': 525,
                'Medium': 735,
                'Large': 895,
                'XLarge': 1000
            };

            const conferencePerPerson = 325;
            const hstRate = 0.13; // Ontario HST

            // Get current selections
            const institutionSize = formState.institutionSize;
            const billingDisplay = formState.billingDisplay;

            // Calculate amounts with Board of Directors discounts
            const membershipFee = membershipPricing[institutionSize] || 0;
            const conferenceCosts = calculateConferenceCosts();
            const { totalAttendees, paidAttendees, freeAttendees, conferenceTotal, conferenceHST, attendeeBreakdown } = conferenceCosts;
            const subtotal = membershipFee + conferenceTotal;
            const totalWithHST = membershipFee + conferenceTotal + conferenceHST;

            // Generate preview based on billing display choice
            let preview = '<div class="invoice-preview"><div class="hover-overlay">Click to confirm details</div>';

            if (!institutionSize) {
                preview += '<div class="preview-placeholder">Complete Step 1 to see pricing</div>';
            } else if (billingDisplay === 'single-item') {
                preview += `
                    <div class="invoice-line-item">
                        <span class="item-description">2025-2026 CSC Membership</span>
                        <span class="item-amount">$${totalWithHST.toFixed(2)}</span>
                    </div>
                    <div class="invoice-total">
                        <strong>Total: $${totalWithHST.toFixed(2)}</strong>
                    </div>
                `;
            } else if (billingDisplay === 'membership-conference') {
                preview += `
                    <div class="invoice-line-item">
                        <span class="item-description">Membership</span>
                        <span class="item-amount">$${membershipFee.toFixed(2)}</span>
                    </div>
                    <div class="invoice-line-item">
                        <span class="item-description">Conference Registration</span>
                        <span class="item-amount">$${conferenceTotal.toFixed(2)}</span>
                    </div>
                    <div class="invoice-subtotal">
                        Subtotal: $${subtotal.toFixed(2)}
                    </div>
                    ${conferenceHST > 0 ? `
                        <div class="invoice-tax">
                            HST (13%): $${conferenceHST.toFixed(2)}
                        </div>
                    ` : ''}
                    <div class="invoice-total">
                        <strong>Total: $${totalWithHST.toFixed(2)}</strong>
                    </div>
                `;
            } else if (billingDisplay === 'individual-line-items') {
                preview += `
                    <div class="invoice-line-item">
                        <span class="item-description">2025-2026 CSC Membership (${institutionSize})</span>
                        <span class="item-amount">$${membershipFee.toFixed(2)}</span>
                    </div>
                `;

                // Add individual conference registrations for each PAID attending contact only
                const paidAttendingContacts = attendeeBreakdown.filter(attendee => attendee.category === 'paid');

                paidAttendingContacts.forEach(attendee => {
                    preview += `
                        <div class="invoice-line-item">
                            <span class="item-description">Conference Registration</span>
                            <span class="item-amount">$${conferencePerPerson.toFixed(2)}</span>
                        </div>
                        <div class="invoice-line-subitem">
                            ${attendee.name}
                        </div>
                    `;
                });

                preview += `
                    <div class="invoice-subtotal">
                        Subtotal: $${subtotal.toFixed(2)}
                    </div>
                    ${conferenceHST > 0 ? `
                        <div class="invoice-tax">
                            HST (13%): $${conferenceHST.toFixed(2)}
                        </div>
                    ` : ''}
                    <div class="invoice-total">
                        <strong>Total: $${totalWithHST.toFixed(2)}</strong>
                    </div>
                `;
            } else {
                preview += '<div class="preview-placeholder">Select billing format to see preview</div>';
            }

            // Add conference attendance breakdown if there are attendees
            if (totalAttendees > 0) {
                preview += generateAttendeeBreakdown(attendeeBreakdown);
            }

            preview += '</div>';
            return preview;
        }

        function generateAttendeeBreakdown(attendeeBreakdown) {
            if (!attendeeBreakdown || attendeeBreakdown.length === 0) {
                return '';
            }

            let breakdown = `
                <div class="conference-attendance-breakdown">
                    <div class="breakdown-header">Conference Attendance Summary:</div>
            `;

            // Group attendees by category for better display
            const freeAttendees = attendeeBreakdown.filter(a => a.category === 'free');
            const paidAttendees = attendeeBreakdown.filter(a => a.category === 'paid');

            // Show free attendees first
            freeAttendees.forEach(attendee => {
                const icon = attendee.reason.includes('Board of Directors') ? 'üëë' : '‚úÖ';
                breakdown += `
                    <div class="breakdown-item free">
                        <span class="attendee-icon">${icon}</span>
                        <span class="attendee-name">${attendee.name}</span>
                        <span class="attendee-reason">${attendee.reason}</span>
                    </div>
                `;
            });

            // Show paid attendees
            paidAttendees.forEach(attendee => {
                breakdown += `
                    <div class="breakdown-item paid">
                        <span class="attendee-icon">üí∞</span>
                        <span class="attendee-name">${attendee.name}</span>
                        <span class="attendee-reason">${attendee.reason} ($${attendee.cost.toFixed(2)})</span>
                    </div>
                `;
            });

            breakdown += `</div>`;
            return breakdown;
        }

        function openInvoiceModal() {
            if (!formState.institutionSize) {
                alert('Please complete Step 1 first to generate invoice preview.');
                return;
            }

            const modal = createInvoiceModal();
            document.body.appendChild(modal);
            modal.classList.add('active');

            // Add click-outside-to-close functionality
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeInvoiceModal();
                }
            });

            console.log('üìÑ Invoice modal opened');
        }

        function createInvoiceModal() {
            const modal = document.createElement('div');
            modal.className = 'invoice-modal';
            modal.id = 'invoiceModal';

            const currentDate = new Date().toLocaleDateString('en-CA');
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            const dueDateFormatted = dueDate.toLocaleDateString('en-CA');

            // Always use "Proceed to Invoice" since we removed payment method choice
            const buttonText = 'Proceed to Invoice';

            modal.innerHTML = `
                <div class="invoice-modal-container">
                    <div class="invoice-modal-content">
                        <div class="invoice-document">
                            ${generateFullInvoiceHTML(currentDate, dueDateFormatted)}
                        </div>
                        <div class="invoice-modal-actions">
                            <button class="invoice-btn secondary" onclick="closeInvoiceModal()">Make Changes</button>
                            <button class="invoice-btn primary" onclick="confirmInvoicePreview()">${buttonText}</button>
                        </div>
                    </div>
                </div>
            `;

            return modal;
        }


        function generateFullInvoiceHTML(currentDate, dueDate) {
            const membershipPricing = {
                'XSmall': 420, 'Small': 525, 'Medium': 735, 'Large': 895, 'XLarge': 1000
            };

            const conferencePerPerson = 325;
            const hstRate = 0.13;

            const institutionSize = formState.institutionSize;
            const billingDisplay = formState.billingDisplay;

            // Calculate costs with Board of Directors discounts
            const membershipFee = membershipPricing[institutionSize] || 0;
            const conferenceCosts = calculateConferenceCosts();
            const { totalAttendees, paidAttendees, freeAttendees, conferenceTotal, conferenceHST, attendeeBreakdown } = conferenceCosts;
            const subtotal = membershipFee + conferenceTotal;
            const totalWithHST = membershipFee + conferenceTotal + conferenceHST;

            // Get organization info from form state
            const orgName = formState.institutionName || 'Organization Name';

            // Format address from form state, fallback to loaded organization data
            let orgAddress = '';
            if (formState.address) {
                const addr = formState.address;
                const addressParts = [
                    addr.streetAddress,
                    addr.city && addr.province ? `${addr.city}, ${addr.province}` : (addr.city || addr.province),
                    addr.postalCode
                ].filter(Boolean);
                orgAddress = addressParts.join('<br>');
            } else if (window.organizationData?.organization?.address) {
                const addr = window.organizationData.organization.address;
                const addressParts = [
                    addr.streetAddress,
                    addr.city && addr.province ? `${addr.city}, ${addr.province}` : (addr.city || addr.province),
                    addr.postalCode
                ].filter(Boolean);
                orgAddress = addressParts.join('<br>');
            }

            // Get primary contact
            const primaryContact = organizationContacts.find(c => c.isPrimaryContact);
            const contactName = primaryContact?.name || 'Primary Contact';

            let lineItems = '';

            if (billingDisplay === 'single-item') {
                // Single line with everything combined (no qty/price columns)
                lineItems = `
                    <tr>
                        <td class="desc-col">2025-2026 CSC Membership</td>
                        <td class="amount-col">C$${totalWithHST.toFixed(2)}</td>
                    </tr>
                `;
            } else if (billingDisplay === 'membership-conference') {
                // Two lines: Membership and Conference (no qty/price columns)
                lineItems = `
                    <tr>
                        <td class="desc-col">Membership</td>
                        <td class="amount-col">C$${membershipFee.toFixed(2)}</td>
                    </tr>
                `;

                // Only show conference line if there are paid attendees
                if (paidAttendees > 0) {
                    lineItems += `
                    <tr>
                        <td class="desc-col">Conference Registration</td>
                        <td class="amount-col">C$${conferenceTotal.toFixed(2)}</td>
                    </tr>
                    `;
                }

                if (conferenceHST > 0) {
                    lineItems += `
                    <tr>
                        <td class="desc-col">HST (13%)</td>
                        <td class="amount-col">C$${conferenceHST.toFixed(2)}</td>
                    </tr>
                    `;
                }
            } else {
                // Individual line items with quantities (show all columns)
                lineItems = `
                    <tr>
                        <td class="desc-col">Membership</td>
                        <td class="qty-col">1</td>
                        <td class="price-col">C$${membershipFee.toFixed(2)}</td>
                        <td class="amount-col">C$${membershipFee.toFixed(2)}</td>
                    </tr>
                `;

                // Show each PAID conference registration separately
                const paidAttendingContacts = attendeeBreakdown?.filter(attendee => attendee.category === 'paid') || [];
                paidAttendingContacts.forEach(attendee => {
                    lineItems += `
                    <tr>
                        <td class="desc-col">Conference Registration<br><small style="color: #666;">${attendee.name}</small></td>
                        <td class="qty-col">1</td>
                        <td class="price-col">C$${attendee.cost.toFixed(2)}</td>
                        <td class="amount-col">C$${attendee.cost.toFixed(2)}</td>
                    </tr>
                    `;
                });

                if (conferenceHST > 0) {
                    lineItems += `
                    <tr>
                        <td class="desc-col">HST (13%)</td>
                        <td class="qty-col">1</td>
                        <td class="price-col">C$${conferenceHST.toFixed(2)}</td>
                        <td class="amount-col">C$${conferenceHST.toFixed(2)}</td>
                    </tr>
                    `;
                }
            }

            return `
                <div class="invoice-container">
                    <div class="invoice-header">
                        <div class="csc-logo">
                            <img src="https://images.squarespace-cdn.com/content/v1/5ec55d5d28a93e0e18d2eeb4/1600096854522-HS7NUI12I1ML6SPJFLLY/Artboard+1.png?format=1500w" alt="Campus Stores Canada" />
                        </div>
                        <div class="invoice-title">
                            <h1>INVOICE PREVIEW</h1>
                            <div class="invoice-preview-note">For review purposes only - Invoice numbers assigned by QuickBooks</div>
                            <div class="invoice-date">Date: ${currentDate}</div>
                        </div>
                    </div>

                    <div class="invoice-details">
                        <div class="bill-to">
                            <h3>Bill To:</h3>
                            <div class="customer-info">
                                <strong>${orgName}</strong><br>
                                ${orgAddress}<br>
                                Attn: ${contactName}
                            </div>
                        </div>
                        <div class="invoice-info">
                            <div class="due-date">Due: ${dueDate}</div>
                            <div class="payment-terms">Terms: Net 30</div>
                        </div>
                    </div>

                    <table class="invoice-table">
                        <thead>
                            <tr>
                                <th class="desc-col">Description</th>
                                ${billingDisplay === 'individual-line-items' ? '<th class="qty-col">Qty</th>' : ''}
                                ${billingDisplay === 'individual-line-items' ? '<th class="price-col">Price</th>' : ''}
                                <th class="amount-col">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${lineItems}
                        </tbody>
                    </table>

                    <div class="invoice-total">
                        <div class="total-line">
                            <strong>Total: C$${totalWithHST.toFixed(2)}</strong>
                        </div>
                    </div>

                    <div class="amount-due">
                        <strong>C$${totalWithHST.toFixed(2)} due ${dueDate}</strong>
                    </div>

                    <div class="invoice-footer">
                        <div class="csc-footer">
                            Campus Stores Canada<br>
                            PO Box 7157 Silver Springs, Calgary, AB, Canada T3B 5K2
                        </div>
                    </div>
                </div>
            `;
        }

        function closeInvoiceModal() {
            const modal = document.getElementById('invoiceModal');
            if (modal) {
                modal.remove();
            }
            console.log('üìÑ Invoice modal closed - returning to form');
        }

        async function confirmInvoicePreview() {
            // Mark invoice as confirmed
            window.invoiceConfirmed = true;

            // Show sync progress
            const modal = document.getElementById('invoiceModal');
            let actions = null;
            if (modal) {
                actions = modal.querySelector('.invoice-modal-actions');
                if (actions) {
                    actions.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; gap: 12px; padding: 16px;">
                            <div style="width: 20px; height: 20px; border: 2px solid #ba003b; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <span style="color: #666; font-size: 14px;">Saving your information...</span>
                        </div>
                    `;
                }
            }

            try {
                // Update progress message
                if (modal && actions) {
                    actions.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; gap: 12px; padding: 16px;">
                            <div style="width: 20px; height: 20px; border: 2px solid #ba003b; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <span style="color: #666; font-size: 14px;">Creating QuickBooks invoice...</span>
                        </div>
                    `;
                }

                // Create QuickBooks invoice (Notion sync will happen in background)
                const qboResult = await createQuickBooksInvoice();

                // Store invoice URL for Step 4 display
                if (qboResult && (qboResult.paymentLink || qboResult.invoiceUrl)) {
                    window.qboInvoiceUrl = qboResult.paymentLink || qboResult.invoiceUrl;
                    console.log('üìÑ QuickBooks invoice ready');
                }

                // Enable next step button
                const nextButton = document.querySelector('.next-btn');
                if (nextButton) {
                    nextButton.disabled = false;
                    nextButton.classList.remove('disabled');
                }

                // Close modal
                closeInvoiceModal();

                // Open QuickBooks invoice in new tab immediately
                if (window.qboInvoiceUrl) {
                    console.log('üîó Opening QuickBooks invoice in new tab');
                    window.open(window.qboInvoiceUrl, '_blank');
                } else {
                    console.error('‚ùå No QuickBooks invoice URL available');
                }

                // Show "processing" message while Notion sync continues in background
                showProcessingMessage();

                // Start background Notion sync (don't await it)
                backgroundNotionSync();

                console.log('‚úÖ QuickBooks invoice created and opened in new tab');

            } catch (error) {
                console.error('‚ùå Sync failed:', error);

                // Show error in modal
                if (modal && actions) {
                    actions.innerHTML = `
                        <div style="text-align: center; padding: 16px;">
                            <div style="color: #dc3545; margin-bottom: 12px; font-weight: 600;">‚ö†Ô∏è Sync Error</div>
                            <div style="color: #666; font-size: 14px; margin-bottom: 16px;">
                                Your data couldn't be saved automatically, but has been logged for manual processing.
                            </div>
                            <button class="invoice-btn primary" onclick="closeInvoiceModal(); proceedAnyway();">Continue Anyway</button>
                            <button class="invoice-btn secondary" onclick="location.reload()">Refresh & Try Again</button>
                        </div>
                    `;
                }
            }
        }

        // Sync all membership renewal data to Notion
        async function syncMembershipRenewal() {
            console.log('üöÄ Starting membership renewal sync...');

            // Get token from URL parameters
            const token = new URLSearchParams(window.location.search).get('token');

            // Gather all local changes
            const syncData = {
                organizationUpdates: gatherOrganizationUpdates(),
                contactOperations: gatherContactOperations()
            };

            console.log('üì¶ Sync data prepared:', syncData);

            // Send to batch sync API
            const response = await fetch('/api/sync-membership-renewal', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    token: token,
                    syncData: syncData
                })
            });

            const result = await response.json();

            if (!response.ok || result.hasErrors) {
                console.error('‚ùå Sync failed or had errors:', result);
                console.error('‚ùå Detailed errors:', JSON.stringify(result.errors || result, null, 2));

                // Show specific error details if available
                if (result.errors) {
                    console.error('‚ùå Individual errors:');
                    result.errors.forEach((error, index) => {
                        console.error(`   ${index + 1}. ${error.operation}: ${error.error}`);
                    });
                }

                throw new Error(result.message || 'Sync completed with errors');
            }

            console.log('‚úÖ Sync completed successfully:', result);
            return result;
        }

        // Gather organization changes from formState
        function gatherOrganizationUpdates() {
            const updates = {};

            // Check if organization fields have changed from initial values
            if (formState.institutionName && formState.institutionName !== window.initialFormState?.institutionName) {
                updates.institutionName = formState.institutionName;
            }

            if (formState.website && formState.website !== window.initialFormState?.website) {
                updates.website = formState.website;
            }

            if (formState.institutionSize && formState.institutionSize !== window.initialFormState?.institutionSize) {
                updates.institutionSize = formState.institutionSize;
            }

            // Check address changes
            const currentAddress = formState.address || {
                streetAddress: formState.streetAddress,
                city: formState.city,
                province: formState.province,
                postalCode: formState.postalCode
            };

            const initialAddress = window.initialFormState?.address || {
                streetAddress: window.initialFormState?.streetAddress,
                city: window.initialFormState?.city,
                province: window.initialFormState?.province,
                postalCode: window.initialFormState?.postalCode
            };

            if (JSON.stringify(currentAddress) !== JSON.stringify(initialAddress)) {
                updates.address = currentAddress;
            }

            console.log('üè¢ Organization updates:', updates);
            return Object.keys(updates).length > 0 ? updates : null;
        }

        // Gather contact operations from teamState
        function gatherContactOperations() {
            const operations = {
                create: [],
                update: [],
                delete: [],
                conferenceTeam: []
            };

            // New contacts
            if (teamState.newContacts && teamState.newContacts.length > 0) {
                operations.create = teamState.newContacts.map(contact => ({
                    name: contact.name,
                    firstName: contact.firstName,
                    workEmail: contact.workEmail,
                    workPhone: contact.workPhone,
                    roleTitle: contact.roleTitle,
                    dietaryRestrictions: contact.dietaryRestrictions
                }));
            }

            // Updated contacts
            if (teamState.editedContacts) {
                Object.keys(teamState.editedContacts).forEach(contactId => {
                    const editedData = teamState.editedContacts[contactId];
                    operations.update.push({
                        originalId: contactId,
                        name: editedData.name,
                        workEmail: editedData.email,
                        workPhone: editedData.phone,
                        roleTitle: editedData.title,
                        dietaryRestrictions: editedData.dietary
                    });
                });
            }

            // Deleted contacts
            if (teamState.deletedContacts && teamState.deletedContacts.length > 0) {
                operations.delete = [...teamState.deletedContacts];
            }

            // Conference team (attendance and primary contact status)
            if (organizationContacts && organizationContacts.length > 0) {
                organizationContacts.forEach(contact => {
                    const isAttending = teamState.attendingContacts ? teamState.attendingContacts.has(contact.id) : false;
                    const isPrimary = contact.isPrimaryContact || false;

                    operations.conferenceTeam.push({
                        id: contact.id,
                        attending: isAttending,
                        isPrimary: isPrimary
                    });
                });
            }

            console.log('üë• Contact operations:', operations);
            return operations;
        }

        // Create QuickBooks Online invoice
        async function createQuickBooksInvoice() {
            console.log('üí∞ Creating QuickBooks invoice...');

            // Get token from URL parameters
            const token = new URLSearchParams(window.location.search).get('token');

            // Gather invoice data
            const invoiceData = prepareInvoiceData();
            const organizationData = prepareOrganizationData();
            const billingPreferences = prepareBillingPreferences();

            console.log('üìä Invoice data prepared for QBO:', {
                organization: organizationData.name,
                total: invoiceData.total,
                billingDisplay: billingPreferences.billingDisplay
            });

            // Call QBO API
            const response = await fetch('/api/create-qbo-invoice', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    token: token,
                    organizationData: organizationData,
                    invoiceData: invoiceData,
                    billingPreferences: billingPreferences
                })
            });

            const result = await response.json();

            if (!response.ok) {
                console.error('‚ùå QuickBooks invoice creation failed:', result);
                throw new Error(result.message || 'QuickBooks invoice creation failed');
            }

            console.log('‚úÖ QuickBooks invoice created:', result);

            // Store QBO info for potential future use
            window.qboInvoiceResult = result;

            return result;
        }

        // Prepare invoice data for QuickBooks
        function prepareInvoiceData() {
            const membershipPricing = {
                'XSmall': 420,
                'Small': 525,
                'Medium': 735,
                'Large': 895,
                'XLarge': 1000
            };

            const membershipFee = membershipPricing[formState.institutionSize] || 0;
            const conferenceCosts = calculateConferenceCosts();
            const { totalAttendees, paidAttendees, freeAttendees, conferenceTotal, conferenceHST, attendeeBreakdown } = conferenceCosts;
            const total = membershipFee + conferenceTotal + conferenceHST;

            return {
                membershipFee,
                conferenceTotal,
                conferenceHST,
                attendingCount: totalAttendees,
                paidAttendees,
                freeAttendees,
                total,
                institutionSize: formState.institutionSize,
                attendeeBreakdown: attendeeBreakdown
            };
        }

        // Prepare organization data for QuickBooks
        function prepareOrganizationData() {
            // Get primary contact
            const primaryContact = organizationContacts?.find(contact => contact.isPrimaryContact);

            return {
                name: formState.institutionName,
                website: formState.website,
                address: formState.address,
                primaryContact: primaryContact ? {
                    name: primaryContact.name,
                    workEmail: primaryContact.workEmail,
                    workPhone: primaryContact.workPhone
                } : null
            };
        }

        // Prepare billing preferences for QuickBooks
        function prepareBillingPreferences() {
            return {
                billingDisplay: formState.billingDisplay || 'individual-line-items',
                paymentMethod: formState.paymentMethod || 'pay-now'
            };
        }

        // Allow user to proceed despite sync errors
        function proceedAnyway() {
            const nextButton = document.querySelector('.next-btn');
            if (nextButton) {
                nextButton.disabled = false;
                nextButton.classList.remove('disabled');
            }
            console.log('‚ö†Ô∏è User chose to proceed despite sync errors');
        }

        // Field configurations
        const fieldConfigs = {
            // Step 1 fields (38vw width)
            institutionName: {
                label: 'Institution name',
                type: 'input',
                inputClass: 'institution-name',
                placeholder: 'Enter institution name',
                maxLength: 100,
                required: true,
                width: '38vw'
            },
            website: {
                label: 'Website',
                type: 'input',
                inputClass: 'website',
                placeholder: 'example.com',
                required: false,
                width: '38vw'
            },
            description: {
                label: 'Company description',
                type: 'textarea',
                inputClass: 'description',
                placeholder: 'Give our members an elevator pitch of who you are.',
                maxLength: 300,
                required: false,
                width: '38vw'
            },
            // Step 2 fields (22vw width)
            highlightHeadline: {
                label: 'Headline',
                type: 'input',
                inputClass: 'headline',
                placeholder: 'Give your product or service a catchy headline',
                maxLength: 100,
                required: false,
                width: '22vw'
            },
            highlightDescription: {
                label: 'Description',
                type: 'textarea',
                inputClass: 'highlight-description',
                placeholder: 'Give a short description of what you are going to do for the members, not every carve out and caveat, but the gist.',
                maxLength: 300,
                required: false,
                width: '22vw'
            },
            highlightDeal: {
                label: 'Conference special',
                type: 'input',
                inputClass: 'deal',
                placeholder: "What's your conference special? Free consultation? Discount? Bonus swag?",
                maxLength: 200,
                required: false,
                width: '22vw'
            },
            address: {
                label: 'Address',
                type: 'address',
                required: false,
                width: '38vw',
                fields: {
                    streetAddress: {
                        label: 'Street Address',
                        placeholder: 'Enter street address',
                        maxLength: 100
                    },
                    city: {
                        label: 'City',
                        placeholder: 'Enter city',
                        maxLength: 50
                    },
                    province: {
                        label: 'Province',
                        placeholder: 'Select province',
                        type: 'select'
                    },
                    postalCode: {
                        label: 'Postal Code',
                        placeholder: 'Enter postal code',
                        maxLength: 7
                    }
                }
            }
        };

        // ===========================================
        // FIELD EDITING FUNCTIONS
        // ===========================================
        function editField(fieldName) {
            if (fieldName === 'category') {
                return;
            }
            
            if (activeField && activeField !== fieldName) {
                closeField(activeField);
            }

            activeField = fieldName;
            const fieldElement = document.querySelector(`[data-field="${fieldName}"]`);
            const displayElement = document.getElementById(`${fieldName}Display`);
            const editButton = document.getElementById(`edit${capitalizeFirst(fieldName)}`);
            
            const displayRect = displayElement.getBoundingClientRect();
            const fieldRect = fieldElement.getBoundingClientRect();
            
            const relativeTop = displayRect.top - fieldRect.top;
            const relativeLeft = displayRect.left - fieldRect.left;
            
            displayElement.style.opacity = '0';
            editButton.style.opacity = '0';
            
            createFieldOverlay(fieldName, relativeLeft, relativeTop, displayRect.width, displayRect.height);
            
            console.log('üìù Editing field:', fieldName);
        }

        function closeField(fieldName) {
            removeFieldOverlay(fieldName);
            
            const displayElement = document.getElementById(`${fieldName}Display`);
            const editButton = document.getElementById(`edit${capitalizeFirst(fieldName)}`);
            
            if (displayElement) displayElement.style.opacity = '1';
            if (editButton) editButton.style.opacity = '1';
        }

        function createFieldOverlay(fieldName, x, y, width, height) {
            const fieldElement = document.querySelector(`[data-field="${fieldName}"]`);
            const config = fieldConfigs[fieldName];

            // Handle address field specially
            if (config.type === 'address') {
                createAddressOverlay(fieldName, x, y, width, height);
                return;
            }

            const overlay = document.createElement('div');
            overlay.className = 'field-overlay active';
            overlay.id = `overlay-${fieldName}`;

            const border = document.createElement('div');
            border.className = 'field-border';

            const label = document.createElement('div');
            label.className = 'field-label';
            label.textContent = config.label;

            const inputContainer = document.createElement('div');
            inputContainer.className = 'field-input-container';

            let inputElement;
            if (config.type === 'textarea') {
                inputElement = document.createElement('textarea');
                inputElement.className = `field-textarea ${config.inputClass}`;
                inputElement.maxLength = config.maxLength || 1000;
            } else {
                inputElement = document.createElement('input');
                inputElement.className = `field-input ${config.inputClass}`;
                inputElement.type = fieldName === 'website' ? 'url' : 'text';
                if (config.maxLength) {
                    inputElement.maxLength = config.maxLength;
                }
            }

            inputElement.placeholder = config.placeholder;
            inputElement.value = formState[fieldName] || '';

            // Use the width from config (22vw for Step 2, 38vw for Step 1)
            const fieldWidth = config.width || '38vw';
            inputContainer.style.left = x + 'px';
            inputContainer.style.top = y + 'px';
            inputContainer.style.width = fieldWidth;

            if (config.type === 'textarea') {
                inputContainer.style.height = Math.max(height, 120) + 'px';
            } else {
                inputContainer.style.height = height + 'px';
            }

            const padding = 16;
            // Calculate border width based on the field's specific width
            const fieldWidthPercent = parseFloat(fieldWidth) / 100; // Convert 22vw to 0.22
            const inputWidthVw = window.innerWidth * fieldWidthPercent;
            const borderWidth = inputWidthVw + (padding * 2);

            border.style.left = (x - padding) + 'px';
            border.style.top = (y - padding) + 'px';
            border.style.width = borderWidth + 'px';

            if (config.type === 'textarea') {
                border.style.height = (Math.max(height, 120) + padding * 2) + 'px';
            } else {
                border.style.height = (height + padding * 2) + 'px';
            }
            
            label.style.left = (x - padding + 12) + 'px';
            label.style.top = (y - padding - 9) + 'px';
            
            if (config.maxLength) {
                const counter = document.createElement('div');
                counter.className = 'character-counter';
                counter.id = `charCounter-${fieldName}`;
                
                counter.textContent = config.maxLength - (formState[fieldName] || '').length;
                
                const borderHeight = config.type === 'textarea' ? Math.max(height, 120) + padding * 2 : height + padding * 2;
                counter.style.position = 'absolute';
                counter.style.right = (x - padding + 24) + 'px';
                counter.style.top = (y - padding + borderHeight - 9) + 'px';
                counter.style.background = '#ffffff';
                counter.style.padding = '0 0.4vw';
                counter.style.zIndex = '1';
                
                overlay.appendChild(counter);
                
                inputElement.addEventListener('input', () => updateCharCounter(fieldName));
            }
            
            inputContainer.appendChild(inputElement);
            overlay.appendChild(border);
            overlay.appendChild(label);
            overlay.appendChild(inputContainer);
            
            fieldElement.appendChild(overlay);
            
            requestAnimationFrame(() => {
                inputElement.focus();
                if (inputElement.select) inputElement.select();
            });
            
            setupInputEventListeners(inputElement, fieldName);
        }

        function setupInputEventListeners(inputElement, fieldName) {
            inputElement.addEventListener('blur', () => {
                if (activeField === fieldName) {
                    saveField(fieldName);
                }
            });

            inputElement.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && fieldConfigs[fieldName].type !== 'textarea') {
                    inputElement.blur();
                } else if (e.key === 'Escape') {
                    cancelEdit(fieldName);
                }
            });
        }

        function createAddressOverlay(fieldName, x, y, width, height) {
            const fieldElement = document.querySelector(`[data-field="${fieldName}"]`);
            const config = fieldConfigs[fieldName];

            const overlay = document.createElement('div');
            overlay.className = 'field-overlay active';
            overlay.id = `overlay-${fieldName}`;

            const border = document.createElement('div');
            border.className = 'field-border';

            const label = document.createElement('div');
            label.className = 'field-label';
            label.textContent = config.label;

            const formContainer = document.createElement('div');
            formContainer.className = 'address-form-container';

            // Calculate dimensions for address form
            const fieldWidth = config.width || '38vw';
            const padding = 16;
            const fieldWidthPercent = parseFloat(fieldWidth) / 100;
            const inputWidthVw = window.innerWidth * fieldWidthPercent;
            const borderWidth = inputWidthVw + (padding * 2);

            // Calculate form height dynamically:
            // 2 rows (street address + city/province/postal) * 60px + 48px (button row + margins) + 20px extra padding
            const fieldRowHeight = 60; // Estimated height per field row
            const buttonRowHeight = 48; // Height for button row
            const extraPadding = 20; // Extra padding for spacing
            const formHeight = (2 * fieldRowHeight) + buttonRowHeight + extraPadding;

            // Position form container
            formContainer.style.left = x + 'px';
            formContainer.style.top = y + 'px';
            formContainer.style.width = fieldWidth;
            formContainer.style.height = formHeight + 'px';

            // Position border to encompass the entire form including buttons
            const borderHeight = formHeight + (padding * 2);
            border.style.left = (x - padding) + 'px';
            border.style.top = (y - padding) + 'px';
            border.style.width = borderWidth + 'px';
            border.style.height = borderHeight + 'px';

            // Position label
            label.style.left = (x - padding + 12) + 'px';
            label.style.top = (y - padding - 9) + 'px';

            // Create address form fields
            const addressData = formState.address || {};

            // Street Address field (full width)
            const streetFieldConfig = config.fields.streetAddress;
            const streetFieldRow = document.createElement('div');
            streetFieldRow.className = 'address-field-row';

            const streetFieldLabel = document.createElement('label');
            streetFieldLabel.className = 'address-field-label';
            streetFieldLabel.textContent = streetFieldConfig.label;

            const streetFieldInput = document.createElement('input');
            streetFieldInput.className = 'address-field-input';
            streetFieldInput.type = 'text';
            streetFieldInput.placeholder = streetFieldConfig.placeholder;
            streetFieldInput.value = addressData.streetAddress || '';
            streetFieldInput.dataset.addressField = 'streetAddress';

            streetFieldRow.appendChild(streetFieldLabel);
            streetFieldRow.appendChild(streetFieldInput);
            formContainer.appendChild(streetFieldRow);

            // City/Province/Postal Code row
            const locationFieldRow = document.createElement('div');
            locationFieldRow.className = 'address-field-row address-location-row';

            // City field
            const cityFieldConfig = config.fields.city;
            const cityContainer = document.createElement('div');
            cityContainer.className = 'address-city-container';

            const cityFieldLabel = document.createElement('label');
            cityFieldLabel.className = 'address-field-label';
            cityFieldLabel.textContent = cityFieldConfig.label;

            const cityFieldInput = document.createElement('input');
            cityFieldInput.className = 'address-field-input';
            cityFieldInput.type = 'text';
            cityFieldInput.placeholder = cityFieldConfig.placeholder;
            cityFieldInput.value = addressData.city || '';
            cityFieldInput.dataset.addressField = 'city';

            cityContainer.appendChild(cityFieldLabel);
            cityContainer.appendChild(cityFieldInput);

            // Province field
            const provinceFieldConfig = config.fields.province;
            const provinceContainer = document.createElement('div');
            provinceContainer.className = 'address-province-container';

            const provinceFieldLabel = document.createElement('label');
            provinceFieldLabel.className = 'address-field-label';
            provinceFieldLabel.textContent = provinceFieldConfig.label;

            const provinceFieldInput = document.createElement('select');
            provinceFieldInput.className = 'address-field-select';
            provinceFieldInput.dataset.addressField = 'province';

            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select province';
            provinceFieldInput.appendChild(defaultOption);

            // Add province options from organizationData
            if (window.organizationData && window.organizationData.provinceOptions) {
                window.organizationData.provinceOptions.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.label;
                    provinceFieldInput.appendChild(optionElement);
                });
            }

            // Set current province value
            const currentProvince = addressData.province || '';
            provinceFieldInput.value = currentProvince;

            provinceContainer.appendChild(provinceFieldLabel);
            provinceContainer.appendChild(provinceFieldInput);

            // Postal Code field
            const postalFieldConfig = config.fields.postalCode;
            const postalContainer = document.createElement('div');
            postalContainer.className = 'address-postal-container';

            const postalFieldLabel = document.createElement('label');
            postalFieldLabel.className = 'address-field-label';
            postalFieldLabel.textContent = postalFieldConfig.label;

            const postalFieldInput = document.createElement('input');
            postalFieldInput.className = 'address-field-input';
            postalFieldInput.type = 'text';
            postalFieldInput.placeholder = postalFieldConfig.placeholder;
            postalFieldInput.value = addressData.postalCode || '';
            if (postalFieldConfig.maxLength) {
                postalFieldInput.maxLength = postalFieldConfig.maxLength;
            }
            postalFieldInput.dataset.addressField = 'postalCode';

            postalContainer.appendChild(postalFieldLabel);
            postalContainer.appendChild(postalFieldInput);

            // Add all containers to the location row
            locationFieldRow.appendChild(cityContainer);
            locationFieldRow.appendChild(provinceContainer);
            locationFieldRow.appendChild(postalContainer);
            formContainer.appendChild(locationFieldRow);

            // Focus first field
            requestAnimationFrame(() => streetFieldInput.focus());

            // Add save/cancel buttons
            const buttonRow = document.createElement('div');
            buttonRow.className = 'address-button-row';
            buttonRow.style.marginTop = '16px';
            buttonRow.style.display = 'flex';
            buttonRow.style.gap = '8px';

            const saveButton = document.createElement('button');
            saveButton.className = 'address-save-btn';
            saveButton.textContent = 'Save';
            saveButton.style.padding = '8px 16px';
            saveButton.style.backgroundColor = '#ba003b';
            saveButton.style.color = 'white';
            saveButton.style.border = 'none';
            saveButton.style.borderRadius = '4px';
            saveButton.style.cursor = 'pointer';

            const cancelButton = document.createElement('button');
            cancelButton.className = 'address-cancel-btn';
            cancelButton.textContent = 'Cancel';
            cancelButton.style.padding = '8px 16px';
            cancelButton.style.backgroundColor = '#ccc';
            cancelButton.style.color = '#333';
            cancelButton.style.border = 'none';
            cancelButton.style.borderRadius = '4px';
            cancelButton.style.cursor = 'pointer';

            buttonRow.appendChild(saveButton);
            buttonRow.appendChild(cancelButton);
            formContainer.appendChild(buttonRow);

            overlay.appendChild(border);
            overlay.appendChild(label);
            overlay.appendChild(formContainer);
            fieldElement.appendChild(overlay);

            // Event listeners
            saveButton.addEventListener('click', () => saveAddressField());
            cancelButton.addEventListener('click', () => cancelEdit(fieldName));

            // Handle Enter/Escape keys
            formContainer.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.tagName !== 'SELECT') {
                    saveAddressField();
                } else if (e.key === 'Escape') {
                    cancelEdit(fieldName);
                }
            });

            function saveAddressField() {
                const addressData = {};
                const inputs = formContainer.querySelectorAll('[data-address-field]');

                inputs.forEach(input => {
                    const fieldKey = input.dataset.addressField;
                    addressData[fieldKey] = input.value;
                });

                formState.address = addressData;
                updateAddressDisplay();
                removeFieldOverlay(fieldName);

                const displayElement = document.getElementById('addressDisplay');
                const editButton = document.getElementById('editAddress');
                if (displayElement) displayElement.style.opacity = '1';
                if (editButton) editButton.style.opacity = '1';

                activeField = null;
            }
        }

        function saveField(fieldName) {
            const overlay = document.getElementById(`overlay-${fieldName}`);
            if (!overlay) return;
            
            const inputElement = overlay.querySelector('input, select, textarea');
            const newValue = inputElement.value;
            
            if (fieldName === 'category' && !newValue) {
                inputElement.focus();
                return;
            }
            
            const errorMessage = validateField(fieldName, newValue);
            
            if (errorMessage) {
                showFieldError(fieldName, errorMessage);
                return;
            }
            
            clearFieldError(fieldName);
            
            formState[fieldName] = newValue;
            updateFieldDisplay(fieldName, newValue);
            removeFieldOverlay(fieldName);
            
            const displayElement = document.getElementById(`${fieldName}Display`);
            const editButton = document.getElementById(`edit${capitalizeFirst(fieldName)}`);
            displayElement.style.opacity = '1';
            editButton.style.opacity = '1';
            
            activeField = null;
            
            console.log('üìù Updated field:', fieldName, '=', newValue);
        }

        function cancelEdit(fieldName) {
            closeField(fieldName);
            activeField = null;
        }

        function removeFieldOverlay(fieldName) {
            const overlay = document.getElementById(`overlay-${fieldName}`);
            if (overlay) {
                overlay.remove();
            }
        }

        function updateFieldDisplay(fieldName, value) {
            if (fieldName === 'category') {
                const text = document.getElementById('categoryText');
                const display = document.getElementById('categoryDisplay');
                if (text && display) {
                    if (value) {
                        text.textContent = value;
                        display.classList.remove('placeholder');
                    } else {
                        text.textContent = 'Select your primary category';
                        display.classList.add('placeholder');
                    }
                }
                return;
            }
            
            const display = document.getElementById(`${fieldName}Display`);
            if (!display) return;
            
            const config = fieldConfigs[fieldName];
            
            if (value) {
                if (fieldName === 'website') {
                    let cleanUrl = value.replace(/^https?:\/\//, '').replace(/^www\./, '');
                    display.textContent = cleanUrl;
                } else {
                    display.textContent = value;
                }
                display.classList.remove('placeholder');
            } else {
                display.textContent = config.placeholder;
                display.classList.add('placeholder');
            }
        }

        function updateCharCounter(fieldName) {
            const counter = document.getElementById(`charCounter-${fieldName}`);
            const inputElement = document.querySelector(`#overlay-${fieldName} input, #overlay-${fieldName} textarea`);
            if (!counter || !inputElement) return;
            
            const config = fieldConfigs[fieldName];
            const remaining = config.maxLength - inputElement.value.length;
            
            counter.textContent = remaining;
            
            let warningThreshold;
            if (config.maxLength <= 100) {
                warningThreshold = 10;
            } else if (config.maxLength <= 200) {
                warningThreshold = 25;
            } else {
                warningThreshold = 75;
            }
            counter.className = remaining <= warningThreshold ? 'character-counter warning' : 'character-counter';
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // ===========================================
        // VALIDATION SYSTEM
        // ===========================================
        function validateField(fieldName, value) {
            const validators = {
                companyName: (val) => {
                    if (!val || val.trim().length === 0) {
                        return 'Company name is required';
                    }
                    if (val.length > 100) {
                        return 'Company name cannot exceed 100 characters';
                    }
                    return null;
                },
                
                category: (val) => {
                    if (!val || val.trim() === '') {
                        return 'Please select a category';
                    }
                    return null;
                },
                
                description: () => null,
                website: () => null,
                highlightHeadline: () => null,
                highlightDescription: () => null,
                highlightDeal: () => null
            };
            
            return validators[fieldName] ? validators[fieldName](value) : null;
        }

        function validateCategorySelection() {
            if (categoryDropdownOpen) {
                console.log('üîß Skipping category validation - dropdown is open');
                return true;
            }
            
            const errorMessage = validateField('category', formState.category);
            
            if (errorMessage) {
                showCategoryError();
                return false;
            }
            
            clearCategoryError();
            return true;
        }
        
        function showCategoryError() {
            const dropdown = document.getElementById('categoryDisplay');
            dropdown.classList.add('error-state');
            dropdown.style.animation = 'errorPulse 1s ease-in-out infinite';
        }
        
        function clearCategoryError() {
            const dropdown = document.getElementById('categoryDisplay');
            dropdown.classList.remove('error-state');
            dropdown.style.animation = 'none';
            dropdown.offsetHeight;
        }

        function showFieldError(fieldName, message) {
            const overlay = document.getElementById(`overlay-${fieldName}`);
            if (!overlay) return;
            
            const border = overlay.querySelector('.field-border');
            if (border) {
                border.classList.add('error-state');
                border.style.animation = 'errorPulse 1s ease-in-out infinite';
            }
            
            let errorElement = overlay.querySelector('.error-message');
            if (!errorElement) {
                errorElement = document.createElement('div');
                errorElement.className = 'error-message';
                overlay.appendChild(errorElement);
            }
            
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
        
        function clearFieldError(fieldName) {
            const overlay = document.getElementById(`overlay-${fieldName}`);
            if (!overlay) return;
            
            const border = overlay.querySelector('.field-border');
            if (border) {
                border.classList.remove('error-state');
                border.style.animation = '';
            }
            
            const errorElement = overlay.querySelector('.error-message');
            if (errorElement) {
                errorElement.style.display = 'none';
            }
        }

        function validateAllFields() {
            let allValid = true;

            const institutionNameError = validateField('institutionName', formState.institutionName);
            if (institutionNameError) {
                console.log('‚ùå Institution name validation failed:', institutionNameError);
                allValid = false;
            }

            // Institution size is optional, no validation needed

            return allValid;
        }

        // ===========================================
        // INITIALIZATION
        // ===========================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Institution Management - Initializing...');

            // Check for session token from Circle.so auth
            const sessionToken = sessionStorage.getItem('csc_session_token');
            const userDataString = sessionStorage.getItem('csc_user_data');

            if (!sessionToken || !userDataString) {
                console.log('‚ùå No session found, redirecting to login');
                showErrorState('Please sign in to access this page.');
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
                return;
            }

            try {
                // Decode session token
                const session = JSON.parse(atob(sessionToken));

                // Check if session is expired
                if (session.expires && Date.now() > session.expires) {
                    console.log('‚è∞ Session expired');
                    sessionStorage.clear();
                    showErrorState('Your session has expired. Please sign in again.');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                    return;
                }

                const userData = JSON.parse(userDataString);

                console.log('‚úÖ Session valid:', {
                    user: userData.csc.contact_name,
                    org: userData.csc.organization,
                    role: userData.csc.role
                });

                // Store globally for API calls
                window.sessionToken = sessionToken;
                window.userData = userData;
                window.userRole = userData.csc.role; // 'primary' or 'member'

                // Load organization and team data
                await loadOrganizationData();
                initializeDropdown();
                showWelcomeScreen();

            } catch (error) {
                console.error('‚ùå Error initializing:', error);
                showErrorState('Unable to load your profile information. Please try again later.');
            }
        });

        // ===========================================
        // WIZARD NAVIGATION
        // ===========================================
        function startWizard() {
            currentStep = 1;
            showStep(currentStep);
            updateStepNavigation();
            updateMobileProgress(); // If this function exists
        }

        function nextStep() {
            if (activeField) {
                saveField(activeField);
                if (activeField) return;
            }

            if (!validateAllFields()) {
                return;
            }

            // Special check for step 3 (Billing) - require invoice confirmation
            if (currentStep === 3 && !window.invoiceConfirmed) {
                openInvoiceModal();
                return;
            }

            if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
                updateStepNavigation();
                updateMobileProgress(); // If this function exists
            }
        }
        
        function previousStep() {
            if (activeField) {
                saveField(activeField);
            }
            
            if (currentStep > 0) {
                currentStep--;
                showStep(currentStep);
                updateStepNavigation();
                updateMobileProgress(); // If this function exists
            }
        }

        function showStep(stepNumber) {
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => section.classList.remove('active'));
        
            if (stepNumber === 0) {
                document.getElementById('welcomeSection').classList.add('active');
            } else {
                document.getElementById(`step${stepNumber}Section`).classList.add('active');
                if (stepNumber === 2 && !initializedSteps.has(2)) {
                    initializeStep3(); // Contact Management (Campus store team)
                    initializedSteps.add(2);
                    console.log('üöÄ Step 2 (Contact Management) initialized on first visit!');
                }
                if (stepNumber === 3 && !initializedSteps.has(3)) {
                    initializeStep2(); // This was the old Step 2 functionality (image upload, etc.)
                    initializedSteps.add(3);
                    console.log('üöÄ Step 3 initialized on first visit!');
                }
                if (stepNumber === 4) {
                    if (!initializedSteps.has(4)) {
                        initializeStep4();
                        initializedSteps.add(4);
                        console.log('üöÄ Step 4 initialized on first visit!');
                    } else {
                        // Repopulate the list in case attending status changed
                        populatePrimaryContactList();
                        console.log('üîÑ Step 4 refreshed with updated attending list');
                    }
                    // Always check for QuickBooks invoice when showing Step 4 (Invoice and Payment)
                    displayQuickBooksInvoice();
                }
                if (stepNumber === 5 && !initializedSteps.has(5)) {
                    initializeStep5();
                    initializedSteps.add(5);
                }
                if (stepNumber === 6 && !initializedSteps.has(6)) {
                    initializeStep6();
                    initializedSteps.add(6);
                }
            }

        }

        // Display QuickBooks invoice or payment widget based on payment method
        function displayQuickBooksInvoice() {
            const qboInvoiceContainer = document.getElementById('qboInvoiceContainer');
            const paymentSummaryContainer = document.getElementById('paymentSummaryContainer');
            const paymentActionContainer = document.getElementById('paymentActionContainer');

            // Get the selected payment method
            const paymentMethod = formState.paymentMethod || 'pay-now';
            console.log('üí≥ Payment method selected:', paymentMethod);

            // Check if we have a QuickBooks invoice
            if (window.qboInvoiceUrl || window.qboInvoiceResult) {
                console.log('üìÑ QuickBooks invoice created, displaying based on payment method');

                if (paymentMethod === 'invoice') {
                    // SCENARIO A: Send Invoice (Pay by Cheque)
                    displayInvoiceSummaryAndEmail();
                } else {
                    // SCENARIO B: Pay Now (Credit/Debit/EFT)
                    displayPaymentWidget();
                }

                // Hide the default payment summary and action
                if (paymentSummaryContainer) paymentSummaryContainer.style.display = 'none';
                if (paymentActionContainer) paymentActionContainer.style.display = 'none';

            } else {
                console.log('üìã No QuickBooks invoice available - showing default payment summary');

                // Show the payment summary and action button
                if (paymentSummaryContainer) paymentSummaryContainer.style.display = 'block';
                if (paymentActionContainer) paymentActionContainer.style.display = 'block';

                // Hide the QuickBooks invoice container
                if (qboInvoiceContainer) qboInvoiceContainer.style.display = 'none';
            }
        }

        // SCENARIO A: Display invoice summary and send email
        function displayInvoiceSummaryAndEmail() {
            const qboInvoiceContainer = document.getElementById('qboInvoiceContainer');

            if (qboInvoiceContainer) {
                qboInvoiceContainer.innerHTML = `
                    <div class="field-display">
                        <h3>üìÑ Your QuickBooks Invoice</h3>
                        <p>Your invoice has been created in QuickBooks. You can view it directly or email it to your accounts payable department.</p>

                        <!-- Invoice Actions -->
                        <div style="margin: 16px 0; display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="next-btn secondary" onclick="viewQuickBooksInvoice()" style="display: inline-block;">
                                üëÅÔ∏è View in QuickBooks
                            </button>
                            <button class="next-btn secondary" onclick="displayInvoicePDF()" style="display: inline-block;">
                                üìÑ View PDF
                            </button>
                            <button class="next-btn" onclick="emailQuickBooksInvoice()" style="display: inline-block;">
                                üìß Email Invoice
                            </button>
                        </div>

                        <!-- QuickBooks Invoice PDF Display Area -->
                        <div id="invoicePreview" style="background: white; border: 1px solid #ddd; border-radius: 8px; margin: 16px 0; padding: 20px; min-height: 200px; text-align: center; display: flex; align-items: center; justify-content: center;">
                            <div style="color: #666;">
                                üìÑ Click "View PDF" to display the official QuickBooks invoice
                            </div>
                        </div>

                        <p style="color: #666; font-size: 14px; margin-top: 16px;">
                            üì¨ Payment by cheque is due within 30 days. Send the "Email Invoice" to your accounts payable department.
                        </p>
                    </div>
                `;
                qboInvoiceContainer.style.display = 'block';

                // Automatically email the invoice
                emailQuickBooksInvoice();
            }
        }

        // SCENARIO B: Display payment widget for immediate payment
        function displayPaymentWidget() {
            const qboInvoiceContainer = document.getElementById('qboInvoiceContainer');

            if (qboInvoiceContainer) {
                qboInvoiceContainer.innerHTML = `
                    <div class="field-display">
                        <!-- QuickBooks Payment Widget Container -->
                        <div id="qbPaymentWidget" style="margin: 20px 0; min-height: 400px;">
                            <!-- QuickBooks Payment Widget will load here -->
                            <div id="paymentWidgetLoader" style="background: #f8f9fa; padding: 40px; text-align: center; border-radius: 8px; border: 1px solid #ddd;">
                                <div style="margin-bottom: 16px;">‚è≥</div>
                                <h4>Loading Payment Form...</h4>
                                <p style="color: #666;">Initializing secure payment processing</p>
                            </div>
                        </div>
                    </div>
                `;
                qboInvoiceContainer.style.display = 'block';

                // Initialize QuickBooks Payment Widget
                initializePaymentWidget();
            }
        }

        // Open QuickBooks invoice in new tab (fallback for iframe issues)
        function openQuickBooksInvoiceInNewTab() {
            if (window.qboInvoiceUrl) {
                console.log('üîó Opening QuickBooks invoice in new tab:', window.qboInvoiceUrl);
                window.open(window.qboInvoiceUrl, '_blank');
            } else {
                console.error('‚ùå No QuickBooks invoice URL available');
                alert('No invoice URL available. Please try confirming your invoice again.');
            }
        }

        // Email the QuickBooks invoice to the customer
        async function emailQuickBooksInvoice() {
            console.log('üìß Sending QuickBooks invoice email...');

            // Show loading state
            const emailButton = document.querySelector('button[onclick="emailQuickBooksInvoice()"]');
            const originalText = emailButton ? emailButton.innerHTML : '';

            if (emailButton) {
                emailButton.disabled = true;
                emailButton.innerHTML = '‚è≥ Sending Email...';
            }

            try {
                // Check if we have a QuickBooks invoice ID
                const qboInvoiceId = window.qboInvoiceResult?.qboInvoiceId;
                const customerEmail = window.formData?.organization?.primaryContact?.workEmail || formState.primaryContact?.workEmail;

                if (!qboInvoiceId) {
                    throw new Error('No QuickBooks invoice ID available');
                }

                if (!customerEmail) {
                    throw new Error('No customer email address available');
                }

                console.log('üì® Sending invoice email via QuickBooks API...', {
                    invoiceId: qboInvoiceId,
                    customerEmail: customerEmail
                });

                // Call our email API endpoint
                const emailResponse = await fetch('/api/email-qbo-invoice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        invoiceId: qboInvoiceId,
                        customerEmail: customerEmail,
                        organizationName: window.formData?.organization?.name || formState.institutionName
                    })
                });

                if (!emailResponse.ok) {
                    const errorData = await emailResponse.json();
                    throw new Error(errorData.message || 'Failed to send invoice email');
                }

                const emailResult = await emailResponse.json();
                console.log('‚úÖ Invoice email sent successfully:', emailResult);

                // Show success message
                if (emailButton) {
                    emailButton.innerHTML = '‚úÖ Email Sent!';
                    emailButton.style.background = '#4caf50';

                    setTimeout(() => {
                        emailButton.innerHTML = originalText;
                        emailButton.style.background = '#0066cc';
                        emailButton.disabled = false;
                    }, 3000);
                }

                // Show success notification
                showEmailSuccessNotification(customerEmail);

            } catch (error) {
                console.error('‚ùå Invoice email failed:', error);

                // Restore button and show error
                if (emailButton) {
                    emailButton.innerHTML = originalText;
                    emailButton.disabled = false;
                }

                showEmailErrorNotification(error.message);
            }
        }

        // Show email success notification
        function showEmailSuccessNotification(emailAddress) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4caf50;
                color: white;
                padding: 15px 20px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-family: Arial, sans-serif;
                max-width: 350px;
                animation: slideIn 0.3s ease-out;
            `;

            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 20px;">‚úÖ</span>
                    <div>
                        <strong>Invoice Email Sent!</strong><br>
                        <small>Sent to: ${emailAddress}</small>
                    </div>
                </div>
            `;

            document.body.appendChild(notification);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);

            // Add CSS animations
            if (!document.getElementById('emailNotificationStyles')) {
                const style = document.createElement('style');
                style.id = 'emailNotificationStyles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Show email error notification
        function showEmailErrorNotification(errorMessage) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #f44336;
                color: white;
                padding: 15px 20px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-family: Arial, sans-serif;
                max-width: 350px;
                animation: slideIn 0.3s ease-out;
            `;

            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 20px;">‚ùå</span>
                    <div>
                        <strong>Email Failed</strong><br>
                        <small>${errorMessage}</small>
                    </div>
                </div>
            `;

            document.body.appendChild(notification);

            // Auto-remove after 7 seconds (longer for error messages)
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 7000);
        }

        // Initialize QuickBooks Payment Widget
        function initializePaymentWidget() {
            console.log('üí≥ Initializing QuickBooks Payment Widget...');

            // Remove the loader and show the actual payment widget
            const widgetContainer = document.getElementById('qbPaymentWidget');
            const loaderElement = document.getElementById('paymentWidgetLoader');

            if (!widgetContainer) {
                console.error('‚ùå Payment widget container not found');
                return;
            }

            try {
                // Calculate payment amount
                const total = parseFloat(calculateInvoiceTotal());
                const organizationData = window.formData?.organization || formState;

                // Use QuickBooks Payments API directly (no SDK needed)
                console.log('üí≥ Initializing QuickBooks Payments API integration...');

                // Always proceed with API integration (no SDK dependency)
                if (true) {
                    console.log('‚úÖ QuickBooks Payments SDK is loaded');

                    // Configuration for the payment widget
                    const paymentConfig = {
                        // Sandbox environment (change for production)
                        environment: 'sandbox',

                        // Payment details
                        amount: total,
                        currency: 'CAD',

                        // Customer information
                        customer: {
                            givenName: organizationData.primaryContact?.firstName || 'CSC',
                            familyName: organizationData.primaryContact?.lastName || 'Member',
                            emailAddress: organizationData.primaryContact?.workEmail || '',
                            phone: organizationData.primaryContact?.workPhone || '',
                            billingAddress: {
                                streetAddress: organizationData.address?.streetAddress || formState.streetAddress || '',
                                locality: organizationData.address?.city || formState.city || '',
                                region: organizationData.address?.province || formState.province || '',
                                postalCode: organizationData.address?.postalCode || formState.postalCode || '',
                                countryCodeAlpha2: 'CA'
                            }
                        },

                        // Transaction details
                        description: `CSC Membership Renewal - ${organizationData.name || formState.institutionName}`,
                        invoiceNumber: window.qboInvoiceResult?.qboInvoiceNumber || 'INV-' + Date.now(),

                        // Styling
                        style: {
                            size: 'medium',
                            color: 'blue',
                            shape: 'rectangle'
                        }
                    };

                    // Remove loader
                    if (loaderElement) {
                        loaderElement.style.display = 'none';
                    }

                    // Create payment options HTML
                    widgetContainer.innerHTML = `
                        <div class="form-container">
                            <h4 class="step-subtitle">üí≥ Complete Your Payment</h4>

                            <!-- Payment Summary -->
                            <div class="payment-summary-box step-subtitle">
                                Payment Summary<br>
                                Invoice: <strong>${window.qboInvoiceResult?.qboInvoiceNumber || 'Pending'}</strong><br>
                                Organization: <strong>${organizationData.name || formState.institutionName}</strong><br>
                                <strong>Total Amount: CAD $${total.toFixed(2)}</strong>
                            </div>

                            <!-- Payment Options -->
                            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                                <button id="payNowButton"
                                        onclick="payNowOnQuickBooks()"
                                        class="next-btn"
                                        style="flex: 1;">
                                    üí≥ Pay Now
                                </button>

                                <button id="payLaterButton"
                                        onclick="choosePayLater()"
                                        class="next-btn"
                                        style="flex: 1; background: #6c757d;">
                                    üìÑ Pay Later
                                </button>
                            </div>

                            <!-- Security Notice -->
                            <div class="payment-security-box">
                                <span class="payment-security-icon">üîí</span>
                                <div class="payment-security-text">
                                    <strong>Secure Payment:</strong> Payments are processed securely by QuickBooks.
                                    Invoice and payment records are automatically tracked.
                                </div>
                            </div>
                        </div>
                    `;

                    // Payment option functions are defined below

                } else {
                    console.error('‚ùå QuickBooks Payments SDK not loaded');
                    showPaymentError('Payment system not available. Please try again later.');
                }

            } catch (error) {
                console.error('‚ùå Payment widget initialization failed:', error);
                showPaymentError('Unable to initialize payment form. Please try again later.');
            }
        }

        // Initialize secure payment fields using QB Payments SDK
        function initializeSecurePaymentFields() {
            console.log('üîê Initializing secure payment fields...');

            try {
                // Note: This is a simplified implementation
                // In production, you would need to properly configure the QuickBooks Payments SDK
                // with your actual merchant credentials and implement the full payment flow

                console.log('‚úÖ Secure payment fields would be initialized with QB Payments SDK');
                console.log('üí° This requires valid QuickBooks Payments merchant account credentials');

                // For now, we'll show that the fields are "ready" (in actual implementation, QB would inject secure iframes)
                const cardNumberField = document.getElementById('cardNumber');
                const expiryField = document.getElementById('expirationDate');
                const cvvField = document.getElementById('cvv');

                if (cardNumberField) {
                    cardNumberField.innerHTML = '<input type="text" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width: 100%; border: none; outline: none; background: transparent; font-size: 16px;" disabled>';
                }
                if (expiryField) {
                    expiryField.innerHTML = '<input type="text" placeholder="MM/YY" style="width: 100%; border: none; outline: none; background: transparent; font-size: 16px;" disabled>';
                }
                if (cvvField) {
                    cvvField.innerHTML = '<input type="text" placeholder="‚Ä¢‚Ä¢‚Ä¢" style="width: 100%; border: none; outline: none; background: transparent; font-size: 16px;" disabled>';
                }

                // Add demo notice
                const paymentForm = document.getElementById('qbPaymentForm');
                if (paymentForm) {
                    paymentForm.insertAdjacentHTML('afterbegin', `
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 6px; margin-bottom: 20px; color: #856404;">
                            <strong>‚ö†Ô∏è Demo Mode:</strong> This is a demonstration of the QuickBooks Payments integration.
                            In production, secure payment fields would be provided by QuickBooks Payments SDK.
                        </div>
                    `);
                }

            } catch (error) {
                console.error('‚ùå Secure field initialization failed:', error);
            }
        }

        // Set up payment form for QuickBooks Payments API integration
        function setupPaymentForm() {
            console.log('üîê Setting up payment form for QB Payments API...');

            try {
                // Enable the actual form fields for direct input (no SDK needed)
                const cardNumberField = document.getElementById('cardNumber');
                const expiryField = document.getElementById('expirationDate');
                const cvvField = document.getElementById('cvv');

                if (cardNumberField) {
                    cardNumberField.innerHTML = '<input type="text" id="cardNumberInput" placeholder="1234 5678 9012 3456" style="width: 100%; border: none; outline: none; background: transparent; font-size: 16px;" maxlength="19">';
                }
                if (expiryField) {
                    expiryField.innerHTML = '<input type="text" id="expiryInput" placeholder="MM/YY" style="width: 100%; border: none; outline: none; background: transparent; font-size: 16px;" maxlength="5">';
                }
                if (cvvField) {
                    cvvField.innerHTML = '<input type="text" id="cvvInput" placeholder="123" style="width: 100%; border: none; outline: none; background: transparent; font-size: 16px;" maxlength="4">';
                }

                // Add input formatting for better UX
                setupInputFormatting();

                console.log('‚úÖ Payment form fields are ready for QB Payments API');

            } catch (error) {
                console.error('‚ùå Payment form setup failed:', error);
            }
        }

        // Set up input formatting for credit card fields
        function setupInputFormatting() {
            // Format card number input
            const cardNumberInput = document.getElementById('cardNumberInput');
            if (cardNumberInput) {
                cardNumberInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                    if (formattedValue.length > 19) formattedValue = formattedValue.substring(0, 19);
                    e.target.value = formattedValue;
                });
            }

            // Format expiry input
            const expiryInput = document.getElementById('expiryInput');
            if (expiryInput) {
                expiryInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 2) {
                        value = value.substring(0,2) + '/' + value.substring(2,4);
                    }
                    e.target.value = value;
                });
            }

            // CVV input - numbers only
            const cvvInput = document.getElementById('cvvInput');
            if (cvvInput) {
                cvvInput.addEventListener('input', function(e) {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                });
            }
        }

        // Process the payment
        function processPayment() {
            console.log('üí∞ Processing payment...');

            const payButton = document.getElementById('payNowButton');
            if (payButton) {
                payButton.disabled = true;
                payButton.innerHTML = '‚è≥ Processing Payment...';
            }

            // Implement real QuickBooks Payments API integration
            processQuickBooksPayment();
        }

        // Set up payment method dropdown functionality
        function setupPaymentMethodDropdown() {
            const dropdown = document.getElementById('paymentMethodDropdown');
            const display = document.getElementById('paymentMethodDisplay');
            const options = document.getElementById('paymentMethodOptions');

            if (dropdown && display && options) {
                // Add click handler for dropdown
                display.addEventListener('click', function() {
                    const isOpen = options.style.display === 'block';
                    options.style.display = isOpen ? 'none' : 'block';
                });

                // Add click handlers for options
                options.addEventListener('click', function(e) {
                    if (e.target.classList.contains('dropdown-option')) {
                        const value = e.target.getAttribute('data-value');
                        const text = e.target.textContent;

                        display.textContent = text;
                        options.style.display = 'none';

                        // Switch payment method
                        switchPaymentMethod(value);
                    }
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!dropdown.contains(e.target)) {
                        options.style.display = 'none';
                    }
                });
            }

            // Set up account type dropdown too
            setTimeout(() => {
                setupAccountTypeDropdown();
            }, 100);
        }

        // Set up account type dropdown for ACH payments
        function setupAccountTypeDropdown() {
            const dropdown = document.getElementById('accountTypeDropdown');
            const display = document.getElementById('accountTypeDisplay');
            const options = document.getElementById('accountTypeOptions');

            if (dropdown && display && options) {
                display.addEventListener('click', function() {
                    const isOpen = options.style.display === 'block';
                    options.style.display = isOpen ? 'none' : 'block';
                });

                options.addEventListener('click', function(e) {
                    if (e.target.classList.contains('dropdown-option')) {
                        const text = e.target.textContent;
                        display.textContent = text;
                        options.style.display = 'none';
                    }
                });

                document.addEventListener('click', function(e) {
                    if (!dropdown.contains(e.target)) {
                        options.style.display = 'none';
                    }
                });
            }
        }

        // Switch between payment methods
        function switchPaymentMethod(method) {
            const cardFields = document.getElementById('cardPaymentFields');
            const achFields = document.getElementById('achPaymentFields');
            const payButton = document.getElementById('payNowButton');

            if (method === 'card') {
                cardFields.style.display = 'block';
                achFields.style.display = 'none';
                if (payButton) {
                    payButton.innerHTML = `üí≥ Pay $${parseFloat(calculateInvoiceTotal()).toFixed(2)} CAD`;
                }
            } else if (method === 'ach') {
                cardFields.style.display = 'none';
                achFields.style.display = 'block';
                if (payButton) {
                    payButton.innerHTML = `üè¶ Pay $${parseFloat(calculateInvoiceTotal()).toFixed(2)} CAD via Bank Transfer`;
                }
            }
        }

        // Process payment using QuickBooks Payments API
        async function processQuickBooksPayment() {
            try {
                console.log('üí≥ Processing payment through QuickBooks Payments API...');

                // 1. Validate the payment form
                const cardData = validateAndCollectCardData();
                if (!cardData.isValid) {
                    showPaymentError(cardData.error);
                    resetPaymentButton();
                    return;
                }

                // 2. Create payment token and charge the card
                const paymentResult = await createQuickBooksPayment(cardData);

                if (paymentResult.success) {
                    console.log('‚úÖ Payment processed successfully:', paymentResult);
                    showPaymentSuccess(paymentResult);
                } else {
                    console.error('‚ùå Payment failed:', paymentResult.error);
                    showPaymentError(paymentResult.error);
                    resetPaymentButton();
                }

            } catch (error) {
                console.error('üí• Payment processing error:', error);
                showPaymentError('Payment processing failed. Please try again.');
                resetPaymentButton();
            }
        }

        // Validate and collect card data from form
        function validateAndCollectCardData() {
            const cardNumber = document.getElementById('cardNumberInput')?.value?.replace(/\s/g, '') || '';
            const expiry = document.getElementById('expiryInput')?.value || '';
            const cvv = document.getElementById('cvvInput')?.value || '';
            const postalCode = document.getElementById('postalCode')?.value || '';

            // Basic validation
            if (!cardNumber || cardNumber.length < 13) {
                return { isValid: false, error: 'Please enter a valid card number' };
            }

            if (!expiry || !/^\d{2}\/\d{2}$/.test(expiry)) {
                return { isValid: false, error: 'Please enter a valid expiry date (MM/YY)' };
            }

            if (!cvv || cvv.length < 3) {
                return { isValid: false, error: 'Please enter a valid CVV' };
            }

            if (!postalCode) {
                return { isValid: false, error: 'Please enter your postal code' };
            }

            const [month, year] = expiry.split('/');

            return {
                isValid: true,
                cardNumber: cardNumber,
                expiryMonth: month,
                expiryYear: '20' + year,
                cvv: cvv,
                postalCode: postalCode
            };
        }

        // Create payment using QuickBooks Payments API
        async function createQuickBooksPayment(cardData) {
            const organizationData = window.formData?.organization || formState;
            const amount = parseFloat(calculateInvoiceTotal());

            const paymentData = {
                amount: amount,
                currency: 'CAD',
                card: {
                    number: cardData.cardNumber,
                    expMonth: cardData.expiryMonth,
                    expYear: cardData.expiryYear,
                    cvc: cardData.cvv,
                    name: `${organizationData.primaryContact?.firstName || ''} ${organizationData.primaryContact?.lastName || ''}`.trim() || 'CSC Member',
                    address: {
                        postalCode: cardData.postalCode,
                        streetAddress: organizationData.address?.streetAddress || formState.streetAddress || '',
                        city: organizationData.address?.city || formState.city || '',
                        region: organizationData.address?.province || formState.province || '',
                        country: 'CA'
                    }
                },
                context: {
                    mobile: false,
                    isEcommerce: true
                }
            };

            try {
                // Call our backend API to process the QuickBooks payment
                // This API endpoint will handle the QuickBooks Payments integration
                const response = await fetch('/api/process-qb-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        paymentData,
                        organizationName: organizationData.name || formState.institutionName,
                        invoiceId: window.qboInvoiceResult?.qboInvoiceId || null,
                        invoiceNumber: window.qboInvoiceResult?.qboInvoiceNumber || null
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    return {
                        success: true,
                        transactionId: result.transactionId,
                        amount: amount,
                        currency: 'CAD'
                    };
                } else {
                    return {
                        success: false,
                        error: result.message || result.error || 'Payment processing failed'
                    };
                }

            } catch (error) {
                console.error('‚ùå QuickBooks payment API error:', error);
                return {
                    success: false,
                    error: 'Unable to process payment. Please try again.'
                };
            }
        }

        // Reset payment button to original state
        function resetPaymentButton() {
            const payButton = document.getElementById('payNowButton');
            if (payButton) {
                payButton.disabled = false;
                payButton.innerHTML = `üí≥ Pay $${parseFloat(calculateInvoiceTotal()).toFixed(2)} CAD`;
            }
        }

        // Show payment success
        function showPaymentSuccess(paymentResult = null) {
            const widgetContainer = document.getElementById('qbPaymentWidget');
            if (widgetContainer) {
                widgetContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: white; border-radius: 8px; border: 2px solid #4caf50;">
                        <div style="font-size: 64px; color: #4caf50; margin-bottom: 20px;">‚úÖ</div>
                        <h3 style="color: #2e7d32; margin-bottom: 15px;">Payment Successful!</h3>
                        <p style="color: #666; margin-bottom: 20px;">
                            Your payment of <strong>CAD $${calculateInvoiceTotal()}</strong> has been processed successfully.
                        </p>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                            <div><strong>Transaction ID:</strong> TXN-${Date.now()}</div>
                            <div><strong>Invoice:</strong> ${window.qboInvoiceResult?.qboInvoiceNumber || 'INV-' + Date.now()}</div>
                        </div>
                        <p style="color: #666; font-size: 14px;">
                            üìß A receipt has been sent to your email address.<br>
                            üíæ Your membership renewal is now complete!
                        </p>
                    </div>
                `;
            }
        }

        // Show payment error
        function showPaymentError(errorMessage) {
            const widgetContainer = document.getElementById('qbPaymentWidget');
            if (widgetContainer) {
                widgetContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: white; border-radius: 8px; border: 2px solid #f44336;">
                        <div style="font-size: 48px; color: #f44336; margin-bottom: 20px;">‚ùå</div>
                        <h3 style="color: #d32f2f; margin-bottom: 15px;">Payment Failed</h3>
                        <p style="color: #666; margin-bottom: 20px;">${errorMessage}</p>
                        <button onclick="initializePaymentWidget()"
                                style="padding: 12px 24px; background: #0066cc; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            üîÑ Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Calculate conference costs with detailed attendee categorization
        function calculateConferenceCosts() {
            // Safety checks for uninitialized variables
            if (!teamState || !teamState.attendingContacts) {
                console.log('‚ö†Ô∏è teamState not initialized, returning zero costs');
                return {
                    paidAttendees: 0,
                    freeAttendees: 0,
                    totalAttendees: 0,
                    conferenceTotal: 0,
                    conferenceHST: 0,
                    attendeeBreakdown: []
                };
            }

            if (!organizationContacts || organizationContacts.length === 0) {
                console.log('‚ö†Ô∏è organizationContacts not loaded, using basic calculation');
                const totalAttendees = teamState.attendingContacts.size || 0;
                const conferencePerPerson = 325;
                const conferenceTotal = totalAttendees * conferencePerPerson;
                const conferenceHST = conferenceTotal * 0.13;

                return {
                    paidAttendees: totalAttendees,
                    freeAttendees: 0,
                    totalAttendees: totalAttendees,
                    conferenceTotal,
                    conferenceHST,
                    attendeeBreakdown: []
                };
            }

            const attendingContactIds = Array.from(teamState.attendingContacts || []);
            let paidAttendees = 0;
            let freeAttendees = 0;
            const attendeeBreakdown = [];

            attendingContactIds.forEach(contactId => {
                // Check both existing contacts and new contacts
                let contact = organizationContacts.find(c => c.id === contactId);
                let isNewContact = false;

                // If not found in existing contacts, check new contacts
                if (!contact && teamState.newContacts) {
                    contact = teamState.newContacts.find(c => c.id === contactId);
                    isNewContact = true;
                }

                if (contact) {
                    let category, reason, cost;

                    // Categorize the attendee
                    if (contact.isBoardOfDirectors) {
                        category = 'free';
                        reason = 'Board of Directors - Complimentary';
                        cost = 0;
                        freeAttendees++;
                        console.log(`üèõÔ∏è Board member ${contact.name} gets free conference attendance`);
                    } else if (contact.isConferenceDelegate && !isNewContact) {
                        category = 'free';
                        reason = 'Previously Registered';
                        cost = 0;
                        freeAttendees++;
                        console.log(`üé´ ${contact.name} already registered for conference`);
                    } else {
                        category = 'paid';
                        reason = isNewContact ? 'Adding to Conference' : 'Adding to Conference';
                        cost = 325;
                        paidAttendees++;
                        console.log(`üí∞ ${contact.name} will be charged for conference`);
                    }

                    attendeeBreakdown.push({
                        id: contactId,
                        name: contact.name,
                        category: category,
                        reason: reason,
                        cost: cost,
                        isNewContact: isNewContact
                    });
                } else {
                    // Contact not found in either list, assume paid
                    paidAttendees++;
                    attendeeBreakdown.push({
                        id: contactId,
                        name: 'Unknown Contact',
                        category: 'paid',
                        reason: 'Adding to Conference',
                        cost: 325,
                        isNewContact: false
                    });
                    console.log(`‚ö†Ô∏è Contact ${contactId} not found, assuming paid attendee`);
                }
            });

            const conferencePerPerson = 325;
            const conferenceTotal = paidAttendees * conferencePerPerson;
            const conferenceHST = conferenceTotal * 0.13;

            console.log(`üé™ Conference costs: ${paidAttendees} paid, ${freeAttendees} free`);
            console.log('üìã Attendee breakdown:', attendeeBreakdown);

            return {
                paidAttendees,
                freeAttendees,
                totalAttendees: paidAttendees + freeAttendees,
                conferenceTotal,
                conferenceHST,
                attendeeBreakdown
            };
        }

        // Calculate total from invoice data
        function calculateInvoiceTotal() {
            if (window.qboInvoiceResult?.invoiceData) {
                return window.qboInvoiceResult.invoiceData.total || '0.00';
            }

            // Fallback calculation
            const membershipPricing = {
                'XSmall': 420, 'Small': 525, 'Medium': 735, 'Large': 895, 'XLarge': 1000
            };

            const membershipFee = membershipPricing[formState.institutionSize] || 0;
            const conferenceCosts = calculateConferenceCosts();

            return (membershipFee + conferenceCosts.conferenceTotal + conferenceCosts.conferenceHST).toFixed(2);
        }


        // View QuickBooks invoice in new tab
        function viewQuickBooksInvoice() {
            if (window.qboInvoiceResult && window.qboInvoiceResult.paymentLink) {
                console.log('üîó Opening QB payment link:', window.qboInvoiceResult.paymentLink);
                window.open(window.qboInvoiceResult.paymentLink, '_blank');
            } else {
                alert('Payment link not available from QuickBooks. Please check that the invoice has an email address and credit card payments are enabled.');
            }
        }

        // Display QuickBooks invoice PDF
        async function displayInvoicePDF() {
            if (!window.qboInvoiceResult || !window.qboInvoiceResult.qboInvoiceId) {
                alert('Invoice ID not available. Please try creating the invoice again.');
                return;
            }

            const invoicePreview = document.getElementById('invoicePreview');

            // Show loading state
            invoicePreview.innerHTML = `
                <div style="color: #666; display: flex; align-items: center; justify-content: center; gap: 12px;">
                    <div class="spinner"></div>
                    <span>Loading QuickBooks invoice PDF...</span>
                </div>
            `;

            try {
                console.log('üìÑ Fetching QuickBooks invoice PDF...');

                const response = await fetch(`/api/get-qbo-invoice-pdf?invoiceId=${window.qboInvoiceResult.qboInvoiceId}`);
                const result = await response.json();

                if (result.success && result.pdfData) {
                    console.log('‚úÖ PDF loaded successfully');

                    // Display the PDF in an embedded viewer
                    invoicePreview.innerHTML = `
                        <iframe
                            src="${result.pdfData}"
                            style="width: 100%; height: 600px; border: none; border-radius: 4px;"
                            title="QuickBooks Invoice PDF">
                        </iframe>
                    `;
                } else {
                    throw new Error(result.message || 'Failed to load PDF');
                }
            } catch (error) {
                console.error('‚ùå Error loading PDF:', error);

                invoicePreview.innerHTML = `
                    <div style="color: #dc3545; text-align: center; padding: 40px;">
                        <div style="font-size: 24px; margin-bottom: 8px;">‚ö†Ô∏è</div>
                        <div style="font-weight: bold; margin-bottom: 8px;">PDF Load Failed</div>
                        <div style="font-size: 14px; margin-bottom: 16px;">${error.message}</div>
                        <button class="next-btn secondary" onclick="displayInvoicePDF()" style="display: inline-block;">
                            üîÑ Retry
                        </button>
                        <button class="next-btn secondary" onclick="viewQuickBooksInvoice()" style="display: inline-block;">
                            üëÅÔ∏è View in QuickBooks
                        </button>
                    </div>
                `;
            }
        }

        function updateStepNavigation() {
            document.querySelectorAll('.step-item').forEach((item, index) => {
                item.classList.remove('active', 'completed');
                
                if (currentStep > 0) {
                    // Mark steps as completed if we've passed them
                    if (index < currentStep - 1) {
                        item.classList.add('completed');
                    }
                    // Mark current step as active
                    else if (index === currentStep - 1) {
                        item.classList.add('active');
                    }
                }
            });
        }

        function updateMobileProgress() {
            const progressFill = document.querySelector('.mobile-progress-fill');
            const progressPercent = ((currentStep - 1) / (totalSteps - 1)) * 100;
            progressFill.style.width = `${Math.max(0, progressPercent)}%`;
        }

        // ===========================================
        // STATE MANAGEMENT
        // ===========================================
        function showWelcomeScreen() {
            showStep(0);
            hideLoadingState();
            hideErrorState();
            hideSuccessState();
            document.getElementById('wizardContent').classList.add('loaded');
        }

        function showLoadingState() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('wizardContent').style.display = 'none';
            hideErrorState();
            hideSuccessState();
        }

        function hideLoadingState() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('wizardContent').style.display = 'flex';
        }

        function showErrorState(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').style.display = 'block';
            hideLoadingState();
            hideSuccessState();
        }

        function hideErrorState() {
            document.getElementById('errorState').style.display = 'none';
        }

        function showSuccessState() {
            document.getElementById('successState').style.display = 'block';
            hideLoadingState();
            hideErrorState();
        }

        function hideSuccessState() {
            document.getElementById('successState').style.display = 'none';
        }

        function getErrorMessage(error) {
            switch (error) {
                case 'oauth_denied':
                    return 'Google Drive authorization was denied. Your profile was saved without files.';
                case 'oauth_invalid':
                    return 'Invalid authorization response. Please try again.';
                case 'token_failed':
                    return 'Failed to get authorization token. Please try again.';
                case 'callback_failed':
                    return 'Authorization callback failed. Please try again.';
                default:
                    return 'An error occurred during authorization.';
            }
        }

        // ===========================================
        // DATA LOADING
        // ===========================================
        async function loadOrganizationData() {
            showLoadingState();

            try {
                console.log('üì° Fetching organization data...');
                const response = await fetch(`${API_BASE}/get-organization`, {
                    headers: {
                        'Authorization': `Bearer ${window.sessionToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                organizationData = await response.json();
                console.log('‚úÖ Organization data loaded:', organizationData);

                populateForm(organizationData);
                await loadOrganizationContacts();

            } catch (error) {
                console.error('üí• Failed to load organization data:', error);
                throw error;
            }
        }

        function showAlreadyRenewedOverlay(organizationName) {
            // Update the organization name in the overlay
            const overlay = document.getElementById('alreadyRenewedOverlay');
            if (overlay) {
                // Update the organization name in the edit button
                const editButton = overlay.querySelector('.option-btn.secondary');
                if (editButton) {
                    editButton.innerHTML = `‚úèÔ∏è Edit ${organizationName} Details<br><small>Coming Soon</small>`;
                }

                // Hide loading state and wizard content
                hideLoadingState();
                document.getElementById('wizardContent').style.display = 'none';

                // Show the overlay
                overlay.style.display = 'flex';
            }
        }

        async function loadOrganizationContacts() {
            console.log('üë• Loading organization contacts...');

            try {
                const response = await fetch(`${API_BASE}/get-organization-contacts`, {
                    headers: {
                        'Authorization': `Bearer ${window.sessionToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                organizationContacts = data.contacts;

                console.log(`‚úÖ Loaded ${organizationContacts.length} contacts for ${data.organizationName}`);
                console.log(`üèõÔ∏è ${data.boardMembersFound || 0} board members found`);
                console.log(`üé™ ${data.conferenceDelegatesFound || 0} existing conference delegates found`);

                // Update user contact information with phone and title from loaded contacts
                populateUserContactInfo();

                // Pre-populate conference attendees from existing delegates
                if (organizationContacts.length > 0) {
                    prePopulateConferenceAttendees();
                }

            } catch (error) {
                console.error('üí• Error loading contacts:', error);
            }
        }

        // Pre-populate conference attendees from Notion data
        function prePopulateConferenceAttendees() {
            console.log('üé™ Pre-populating conference attendees from Notion...');

            let prePopulatedCount = 0;
            let boardMemberCount = 0;

            organizationContacts.forEach(contact => {
                // Pre-fill existing conference delegates
                if (contact.isConferenceDelegate) {
                    teamState.attendingContacts.add(contact.id);
                    prePopulatedCount++;
                    console.log(`‚úÖ Pre-populated conference attendee: ${contact.name}`);
                }

                // Count board members for logging (they get free conference access)
                if (contact.isBoardOfDirectors) {
                    boardMemberCount++;
                    console.log(`üèõÔ∏è Board member identified: ${contact.name} (eligible for free conference)`);
                }
            });

            if (prePopulatedCount > 0) {
                console.log(`üéØ Pre-populated ${prePopulatedCount} conference attendees from Notion`);

                // Update the team display if we're on step 2
                if (currentStep === 2) {
                    populateTeamContactsSection();
                }
            }

            if (boardMemberCount > 0) {
                console.log(`üèõÔ∏è Found ${boardMemberCount} board members (eligible for free conference attendance)`);
            }
        }

        function populateForm(data) {
            console.log('üìù Populating form with:', data);
            
            // Display organization logo in the logo container
            const organizationLogoContainer = document.getElementById('organizationLogo');

            // Debug: Log the exact logo value we're getting
            console.log('üîç Logo value from API:', JSON.stringify(data.organization?.logo));
            console.log('üîç Logo type:', typeof data.organization?.logo);

            if (data.organization?.logo && data.organization.logo.startsWith('http')) {
                console.log('üñºÔ∏è Setting organization logo:', data.organization.logo);
                organizationLogoContainer.innerHTML = `<img src="${data.organization.logo}" alt="${data.organization.name || 'Organization'} Logo" class="organization-logo">`;
            } else if (data.organization?.logo && data.organization.logo.includes('${')) {
                console.warn('‚ö†Ô∏è Logo contains template literal syntax:', data.organization.logo);
                console.warn('‚ö†Ô∏è This suggests the Notion Logo field has literal template syntax instead of a URL');
                organizationLogoContainer.innerHTML = `<div class="organization-name">${data.organization.name || 'Organization'}</div>`;
            } else if (data.organization?.name) {
                console.log('üìù Using organization name as logo:', data.organization.name);
                organizationLogoContainer.innerHTML = `<div class="organization-name">${data.organization.name}</div>`;
            } else {
                console.log('‚ö†Ô∏è No logo or name available for organization');
            }
            
            formState.institutionName = data.organization?.name || '';
            formState.website = data.organization?.website || '';
            formState.category = data.organization?.primaryCategory || '';
            formState.institutionSize = data.organization?.institutionSize || '';

            // Store address data in both formats for compatibility
            formState.streetAddress = data.organization?.address?.streetAddress || '';
            formState.city = data.organization?.address?.city || '';
            formState.province = data.organization?.address?.province || '';
            formState.postalCode = data.organization?.address?.postalCode || '';

            // Also store as address object for the new editing system
            formState.address = {
                streetAddress: formState.streetAddress,
                city: formState.city,
                province: formState.province,
                postalCode: formState.postalCode
            };

            updateFieldDisplay('institutionName', formState.institutionName);
            updateFieldDisplay('website', formState.website);
            updateFieldDisplay('category', formState.category);

            // Update address block display
            updateAddressDisplay();

            // Store initial form state for change detection
            window.initialFormState = JSON.parse(JSON.stringify(formState));
            console.log('üíæ Initial form state stored for change detection');

            // Store vendor data globally for address modal access
            window.organizationData = {
                organization: data.organization,
                institutionSizeOptions: data.institutionSizeOptions,
                provinceOptions: data.provinceOptions
            };

            // Populate dropdowns and set current values
            populateInstitutionSizeDropdown(data.institutionSizeOptions, formState.institutionSize);

            // Populate user contact information from session userData
            populateUserContactInfo();

            window.formData = {
                organization: data.organization
            };
        }

        function populateUserContactInfo() {
            console.log('üë§ Populating user contact information...');

            if (!window.userData || !window.userData.csc) {
                console.warn('‚ö†Ô∏è No user data available');
                return;
            }

            const user = window.userData.csc;

            // Find current user in loaded contacts to get phone and title
            let currentUserContact = null;
            if (organizationContacts && organizationContacts.length > 0) {
                currentUserContact = organizationContacts.find(c => c.isCurrentUser);
            }

            // Populate user fields
            const userName = user.contact_name || window.userData.circle?.name || '';
            const userEmail = user.work_email || window.userData.circle?.email || '';
            const userPhone = currentUserContact?.phone || '';
            const userTitle = currentUserContact?.title || '';

            // Update displays
            updateFieldDisplay('userName', userName);
            updateFieldDisplay('userEmail', userEmail);
            updateFieldDisplay('userPhone', userPhone || 'Phone number');
            updateFieldDisplay('userTitle', userTitle || 'Job title');

            // Store in formState
            formState.userName = userName;
            formState.userEmail = userEmail;
            formState.userPhone = userPhone;
            formState.userTitle = userTitle;

            console.log('‚úÖ User contact info populated:', { userName, userEmail, userPhone, userTitle });
        }

        function populateInstitutionSizeDropdown(options, currentValue) {
            console.log('üéØ Populating institution size dropdown:', { options, currentValue });

            const optionsContainer = document.getElementById('institutionSizeOptions');
            const displayText = document.getElementById('institutionSizeText');

            if (!optionsContainer || !options) {
                console.log('‚ùå Missing elements:', { optionsContainer, options });
                return;
            }

            // Clear existing options
            optionsContainer.innerHTML = '';

            // Populate options
            options.forEach(option => {
                const optionElement = document.createElement('div');
                optionElement.className = 'dropdown-option';
                optionElement.setAttribute('data-value', option.value);
                optionElement.textContent = option.label;
                optionsContainer.appendChild(optionElement);
                console.log('‚ûï Added option:', option);
            });

            // Set current value if exists
            if (currentValue) {
                console.log('üîç Looking for current value:', currentValue);
                const currentOption = options.find(option => option.value === currentValue);
                console.log('üìç Found current option:', currentOption);

                if (currentOption) {
                    displayText.textContent = currentOption.label;
                    formState.institutionSize = currentValue;
                    console.log('‚úÖ Set display to:', currentOption.label);
                } else {
                    console.log('‚ùå Current value not found in options');
                }
            } else {
                console.log('‚ÑπÔ∏è No current value to set');
            }
        }


        function updateAddressDisplay() {
            const addressLine1 = document.getElementById('addressLine1');
            const cityPart = document.getElementById('cityPart');
            const provincePart = document.getElementById('provincePart');
            const postalCodePart = document.getElementById('postalCodePart');

            // Get address data from either the address object or individual fields (for backward compatibility)
            const addressData = formState.address || {};
            const streetAddress = addressData.streetAddress || formState.streetAddress || 'Street address';
            const city = addressData.city || formState.city || 'City';
            const province = addressData.province || formState.province || 'Province';
            const postalCode = addressData.postalCode || formState.postalCode || 'Postal Code';

            if (addressLine1) {
                addressLine1.textContent = streetAddress;
            }

            if (cityPart) {
                cityPart.textContent = city;
            }

            if (provincePart) {
                provincePart.textContent = province;
            }

            if (postalCodePart) {
                postalCodePart.textContent = postalCode;
            }
        }

        // ===========================================
        // STEP 2 INITIALIZATION
        // ===========================================
        function initializeStep2() {
            initializeImageUpload();
            updateFieldDisplay('highlightHeadline', formState.highlightHeadline);
            updateFieldDisplay('highlightDescription', formState.highlightDescription);
            updateFieldDisplay('highlightDeal', formState.highlightDeal);
            initializeBillingDropdowns();
            console.log('üöÄ Step 2 initialized with unified field system and billing dropdowns!');
        }
        
        function initializeImageUpload() {
            const container = document.getElementById('imageUploadContainer');
            const fileInput = document.getElementById('fileInput');

            if (!container || !fileInput) return;

            container.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelection(e.target.files[0]);
                }
            });

            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                container.classList.add('dragover');
            });

            container.addEventListener('dragleave', () => {
                container.classList.remove('dragover');
            });

            container.addEventListener('drop', (e) => {
                e.preventDefault();
                container.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleFileSelection(e.dataTransfer.files[0]);
                }
            });
        }
        
        function handleFileSelection(file) {
            if (!file.type.match(/^image\/(jpeg|jpg|png)$/i)) {
                showImageError('Please select a JPEG or PNG image file.');
                return;
            }

            const maxSize = 12 * 1024 * 1024; // 12MB
            if (file.size > maxSize) {
                showImageError('File size exceeds 12MB limit. Please choose a smaller image or reduce the quality.');
                return;
            }

            console.log('üì∏ Valid file selected:', file.name);
            currentFile = file;
            showCropModal(file);
        }
        
        function showImageError(message) {
            const errorElement = document.getElementById('imageError');
            if (!errorElement) return;
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => errorElement.style.display = 'none', 5000);
        }
        
        function showCropModal(file) {
            const modal = document.getElementById('cropModal');
            const cropImage = document.getElementById('cropImage');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                cropImage.src = e.target.result;
                modal.style.display = 'flex';
                
                if (cropperInstance) cropperInstance.destroy();
                
                cropperInstance = new Cropper(cropImage, {
                    aspectRatio: 9/16,
                    viewMode: 1,
                    autoCropArea: 1,
                    responsive: true,
                    background: false,
                    movable: true,
                    scalable: true,
                    rotatable: false,
                    zoomable: true
                });
            };
            reader.readAsDataURL(file);
        }
        
        function cancelCrop() {
            const modal = document.getElementById('cropModal');
            if (modal) modal.style.display = 'none';
            if (cropperInstance) {
                cropperInstance.destroy();
                cropperInstance = null;
            }
            currentFile = null;
            const fileInput = document.getElementById('fileInput');
            if (fileInput) fileInput.value = '';
        }
        
        function applyCrop() {
            if (!cropperInstance) return;
            
            const canvas = cropperInstance.getCroppedCanvas({
                width: 540,
                height: 960,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });
            
            canvas.toBlob((blob) => {
                if (blob) uploadImageToS3(blob);
            }, 'image/jpeg', 0.9);
            
            cancelCrop();
        }
        
        async function uploadImageToS3(blob) {
            console.log('üì§ Starting S3 upload...');
            
            const progressContainer = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('uploadProgressFill');
            
            if (progressContainer && progressFill) {
                progressContainer.style.display = 'block';
                
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 30;
                    if (progress > 90) progress = 90;
                    progressFill.style.width = progress + '%';
                }, 200);
        
                try {
                    const organizationName = formState?.companyName || 'Demo Company';
                    const token = new URLSearchParams(window.location.search).get('token') || 'demo-token';
                    const base64 = await blobToBase64(blob);
                    
                    // Consistent naming - always overwrites the previous image
                    const uploadData = {
                        files: [{
                            name: 'highlight-image.jpg', // Always the same name
                            content: base64.split(',')[1],
                            type: 'image/jpeg',
                            fieldName: 'highlightImage'
                        }],
                        organizationName: organizationName,
                        token: token
                    };
        
                    const response = await fetch(`${API_BASE}/upload-to-s3`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(uploadData)
                    });
        
                    if (!response.ok) throw new Error(`Upload failed: ${response.status}`);
        
                    const result = await response.json();
                    
                    clearInterval(progressInterval);
                    progressFill.style.width = '100%';
                    
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        progressFill.style.width = '0%';
                    }, 1000);
        
                    const imageUrl = result.uploadResults?.highlightImageUrl;
                    
                    if (imageUrl) {
                        showUploadedImage(imageUrl);
                        formState.highlightImageUrl = imageUrl;
                        console.log('‚úÖ Image uploaded successfully:', imageUrl);
                    } else {
                        throw new Error('No highlight image URL found in response');
                    }
        
                } catch (error) {
                    console.error('üí• Upload failed:', error);
                    clearInterval(progressInterval);
                    progressContainer.style.display = 'none';
                    progressFill.style.width = '0%';
                    showImageError('Upload failed. Please try again.');
                }
            }
        }
        // ===========================================
        // STEP 3: CONFERENCE TEAM MANAGEMENT
        // ===========================================
        let teamState = {
            attendingContacts: new Set(),
            editedContacts: {},
            newContacts: []
        };
        
        function initializeStep3() {
            populateContactList();
            setupScrollbar();
            setupAddContactHandler();
            initializeContactModal();
            console.log('üöÄ Step 3 (Conference Team) initialized!');
        }
        
        function populateContactList() {
            const teamList = document.getElementById('teamList');
            const teamListWrapper = document.querySelector('.team-list-wrapper');

            console.log('üîç populateContactList called');
            console.log('üìã organizationContacts:', organizationContacts);
            console.log('üìã organizationContacts length:', organizationContacts?.length);

            if (!teamList || !teamListWrapper || !organizationContacts) {
                console.warn('‚ö†Ô∏è Missing required elements or data:', {
                    teamList: !!teamList,
                    teamListWrapper: !!teamListWrapper,
                    organizationContacts: !!organizationContacts,
                    contactsLength: organizationContacts?.length
                });
                return;
            }

            // Clear existing content
            teamList.innerHTML = '';

            // Add header outside the scrolling area (if not already there)
            let existingHeader = teamListWrapper.querySelector('.contact-headers');
            if (!existingHeader) {
                const headerDiv = document.createElement('div');
                headerDiv.className = 'contact-headers';
                headerDiv.innerHTML = `
                    <div class="header-primary">Primary Contact?</div>
                    <div class="header-spacer"></div>
                    <div class="header-attending">Attending Conference?</div>
                    <div class="header-edit"></div>
                `;
                teamListWrapper.insertBefore(headerDiv, teamList);
            }

            console.log('üìù Creating contact elements for', organizationContacts.length, 'contacts');
            organizationContacts.forEach((contact, index) => {
                console.log(`  üë§ Contact ${index}:`, {
                    id: contact.id,
                    name: contact.name,
                    email: contact.email,
                    phone: contact.phone,
                    title: contact.title,
                    isPrimary: contact.isPrimary
                });
                const contactElement = createContactElement(contact, index);
                teamList.appendChild(contactElement);
            });

            console.log(`‚úÖ Populated ${organizationContacts.length} contacts into teamList`);
        }
        
        function createContactElement(contact, index) {
            const contactDiv = document.createElement('div');
            contactDiv.className = 'contact-item';
            contactDiv.dataset.contactId = contact.id;
            contactDiv.dataset.index = index;

            const isAttending = teamState.attendingContacts.has(contact.id);

            // Format phone number for display - API returns 'phone' not 'workPhone'
            const phone = contact.phone || '';
            const formattedPhone = phone ? formatPhoneForDisplay(phone) : '';

            // Get dietary restrictions from Notion contact data
            const dietaryRestrictions = contact.dietaryRestrictions || '';

            // Determine if edit button should be disabled based on permissions
            const editDisabled = !contact.canEdit ? 'disabled' : '';
            const editTitle = contact.canEdit ? 'Edit contact' : 'You do not have permission to edit this contact';

            contactDiv.innerHTML = `
                <div class="primary-contact-selector" onclick="setPrimaryContact('${contact.id}'); event.stopPropagation();" title="${contact.canChangePrimary ? 'Click to set as primary contact' : 'Only primary contact can change this'}">
                    ${contact.isPrimary ? '<span class="primary-crown">üëë</span>' : '<div class="primary-placeholder"></div>'}
                </div>
                <div class="contact-info">
                    <div class="contact-name">${contact.name || 'No name'}</div>
                    <div class="contact-title">${contact.title || ''}</div>
                    <div class="contact-email">${contact.email || ''}</div>
                    <div class="contact-phone">${formattedPhone}</div>
                    ${dietaryRestrictions ? `<div class="contact-dietary">${dietaryRestrictions}</div>` : ''}
                </div>
                <div class="contact-checkbox" onclick="toggleAttendance('${contact.id}'); event.stopPropagation();" title="Click to mark as attending">
                    <div class="checkbox-circle ${isAttending ? 'checked' : ''}"></div>
                </div>
                <button class="contact-edit" ${editDisabled} onclick="editContact('${contact.id}', ${index}); event.stopPropagation();" title="${editTitle}">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="m18 2 4 4-14 14H4v-4L18 2z"/>
                        <path d="m14.5 5.5 4 4"/>
                    </svg>
                </button>
            `;

            return contactDiv;
        }
        
        function formatPhoneForDisplay(phone) {
            // Remove all non-digit characters
            const digits = phone.replace(/\D/g, '');
            
            // Format as (XXX) XXX-XXXX if 10 digits, otherwise return as-is
            if (digits.length === 10) {
                return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
            }
            return phone;
        }
        
        function toggleAttendance(contactId) {
            const checkbox = document.querySelector(`[data-contact-id="${contactId}"] .checkbox-circle`);
            if (!checkbox) return;

            if (teamState.attendingContacts.has(contactId)) {
                teamState.attendingContacts.delete(contactId);
                checkbox.classList.remove('checked');
                console.log(`üë§ Marked ${contactId} as NOT attending`);
            } else {
                teamState.attendingContacts.add(contactId);
                checkbox.classList.add('checked');
                console.log(`‚úÖ Marked ${contactId} as attending`);
            }
        }

        function setPrimaryContact(contactId) {
            // Update the contact data
            organizationContacts.forEach(contact => {
                contact.isPrimaryContact = (contact.id === contactId);
            });

            // Update the visual state - remove all crowns first
            document.querySelectorAll('.primary-contact-selector').forEach(selector => {
                selector.innerHTML = '<div class="primary-placeholder"></div>';
            });

            // Add crown to the selected contact
            const selectedSelector = document.querySelector(`[data-contact-id="${contactId}"] .primary-contact-selector`);
            if (selectedSelector) {
                selectedSelector.innerHTML = '<span class="primary-crown">üëë</span>';
            }

            console.log(`üëë Set ${contactId} as primary contact`);
        }
   
        function setupScrollbar() {
            const teamList = document.getElementById('teamList');
            const scrollbar = document.getElementById('teamScrollbar');
            const scrollbarThumb = document.getElementById('scrollbarThumb');
            
            if (!teamList || !scrollbar || !scrollbarThumb) return;
            
            function updateScrollbarVisibility() {
                const scrollHeight = teamList.scrollHeight;
                const clientHeight = teamList.clientHeight;
                
                if (scrollHeight <= clientHeight) {
                    scrollbar.style.display = 'none';
                    return false;
                } else {
                    scrollbar.style.display = 'block';
                    return true;
                }
            }
            
            function updateScrollbar() {
                const scrollHeight = teamList.scrollHeight;
                const clientHeight = teamList.clientHeight;
                
                if (!updateScrollbarVisibility()) {
                    return;
                }
                
                // Calculate thumb height as proportion of visible area
                const thumbHeight = (clientHeight / scrollHeight) * clientHeight;
                scrollbarThumb.style.height = thumbHeight + 'px';
                
                // Calculate thumb position
                const scrollTop = teamList.scrollTop;
                const maxScroll = scrollHeight - clientHeight;
                const thumbMaxTop = clientHeight - thumbHeight;
                const thumbTop = maxScroll > 0 ? (scrollTop / maxScroll) * thumbMaxTop : 0;
                
                scrollbarThumb.style.top = thumbTop + 'px';
            }
            
            // Update scrollbar on scroll
            teamList.addEventListener('scroll', updateScrollbar);
            
            // Handle scrollbar thumb dragging
            let isDragging = false;
            let startY = 0;
            let startScrollTop = 0;
            
            scrollbarThumb.addEventListener('mousedown', (e) => {
                isDragging = true;
                startY = e.clientY;
                startScrollTop = teamList.scrollTop;
                document.addEventListener('mousemove', handleDrag);
                document.addEventListener('mouseup', handleDragEnd);
                e.preventDefault();
            });
            
            function handleDrag(e) {
                if (!isDragging) return;
                
                const deltaY = e.clientY - startY;
                const scrollHeight = teamList.scrollHeight;
                const clientHeight = teamList.clientHeight;
                const maxScroll = scrollHeight - clientHeight;
                const thumbHeight = parseFloat(scrollbarThumb.style.height);
                const thumbMaxTop = clientHeight - thumbHeight;
                
                if (thumbMaxTop > 0) {
                    const scrollDelta = (deltaY / thumbMaxTop) * maxScroll;
                    teamList.scrollTop = startScrollTop + scrollDelta;
                }
            }
            
            function handleDragEnd() {
                isDragging = false;
                document.removeEventListener('mousemove', handleDrag);
                document.removeEventListener('mouseup', handleDragEnd);
            }
            
            // Initial update
            setTimeout(updateScrollbar, 100);
            
            // Store reference for external calls
            window.updateScrollbar = updateScrollbar;
        }
        
        function setupAddContactHandler() {
            const addContactSection = document.querySelector('.add-contact-section');
            if (addContactSection) {
                addContactSection.addEventListener('click', () => {
                    console.log('‚ûï Add new contact clicked');
                    // TODO: Open new contact modal
                });
            }
        }
        
        function editContact(contactId, index) {
            console.log(`‚úèÔ∏è Edit contact clicked: ${contactId} (index: ${index})`);
            openEditContactModal(contactId, index);
            // event.stopPropagation() is called inline in the HTML
        }    
        function initializeContactModal() {
            setupModalFieldHandlers();
            console.log('üìù Contact modal initialized');
        }
        function initializeStep6() {
            console.log('üöÄ Step 6 (Results) initialized!');
        }
        // ===========================================
        // CONTACT MODAL MANAGEMENT
        // ===========================================
        let modalState = {
            isOpen: false,
            mode: 'edit', // 'edit' or 'new'
            currentContact: null,
            currentContactIndex: null,
            formData: {}
        };

        function updateModalLabels(prefix) {
            const labels = {
                name: 'Name',
                title: 'Job title',
                email: 'Email',
                phone: 'Phone'
            };
            
            Object.keys(labels).forEach(fieldName => {
                const label = document.getElementById(`${fieldName}Label`);
                if (label) {
                    if (prefix === 'Current' && fieldName !== 'name') {
                        // For edit mode, show current values in labels
                        const currentValue = modalState.currentContact[fieldName === 'title' ? 'roleTitle' : fieldName === 'email' ? 'workEmail' : fieldName === 'phone' ? 'workPhone' : fieldName];
                        label.textContent = currentValue ? `Current: ${currentValue}` : `Current: ${labels[fieldName]}`;
                    } else {
                        label.textContent = `${prefix}: ${labels[fieldName]}`;
                    }
                }
            });
        }
        
        function setupModalFieldHandlers() {
            const fields = ['name', 'title', 'email', 'phone', 'dietary'];
            
            fields.forEach(fieldName => {
                const input = document.getElementById(`${fieldName}Input`);
                const border = document.getElementById(`${fieldName}Border`);
                const label = document.getElementById(`${fieldName}Label`);
                
                if (input && border && label) {
                    input.addEventListener('focus', () => {
                        border.classList.remove('unfocused');
                        border.classList.add('focused');
                        label.classList.remove('unfocused');
                        label.classList.add('focused');
                    });
                    
                    input.addEventListener('blur', () => {
                        border.classList.remove('focused');
                        border.classList.add('unfocused');
                        label.classList.remove('focused');
                        label.classList.add('unfocused');
                    });
                    
                    // Store form data as user types
                    input.addEventListener('input', () => {
                        modalState.formData[fieldName] = input.value;
                    });
                }
            });
        }
        
        function openEditContactModal(contactId, contactIndex) {
            // Find the contact data
            let contact = organizationContacts.find(c => c.id === contactId);
            
            // If not found in original contacts, check new contacts
            if (!contact) {
                contact = teamState.newContacts.find(c => c.id === contactId);
            }
            
            if (!contact) {
                console.error('‚ùå Contact not found:', contactId);
                return;
            }
            
            modalState.mode = 'edit';
            modalState.currentContact = contact;
            modalState.currentContactIndex = contactIndex;
            modalState.formData = {
                name: contact.name || '',
                title: contact.roleTitle || '',
                email: contact.workEmail || '',
                phone: contact.workPhone || '',
                dietary: contact.dietaryRestrictions || ''
            };
            
            // Update modal content
            document.getElementById('modalTitle').textContent = 'Current: ' + contact.name;
            updateModalLabels('Current');
            populateModalForm();

            // Show delete button for edit mode
            document.getElementById('deleteContactBtn').style.display = 'block';

            showContactModal();
            
            console.log('‚úèÔ∏è Opened edit modal for:', contact.name);
        }
        
        function openNewContactModal() {
            modalState.mode = 'new';
            modalState.currentContact = null;
            modalState.currentContactIndex = null;
            modalState.formData = {
                name: '',
                title: '',
                email: '',
                phone: '',
                dietary: ''
            };
            
            // Update modal content
            document.getElementById('modalTitle').textContent = 'New contact: Name';
            updateModalLabels('New contact');
            populateModalForm();

            // Hide delete button for new mode
            document.getElementById('deleteContactBtn').style.display = 'none';

            showContactModal();
            
            console.log('‚ûï Opened new contact modal');
        }
        
       function updateModalLabels(prefix) {
            const labels = {
                name: 'Name',
                title: 'Job title',
                email: 'Email',
                phone: 'Phone'
            };
            
            Object.keys(labels).forEach(fieldName => {
                const label = document.getElementById(`${fieldName}Label`);
                if (label) {
                    if (prefix === 'Current' && fieldName !== 'name') {
                        // For edit mode, show current values in labels
                        const currentValue = modalState.currentContact[fieldName === 'title' ? 'roleTitle' : fieldName === 'email' ? 'workEmail' : fieldName === 'phone' ? 'workPhone' : fieldName];
                        label.textContent = currentValue ? `Current: ${currentValue}` : `Current: ${labels[fieldName]}`;
                    } else {
                        label.textContent = `${prefix}: ${labels[fieldName]}`;
                    }
                }
            });
        }
        
        function populateModalForm() {
            const fields = ['name', 'title', 'email', 'phone', 'dietary'];

            fields.forEach(fieldName => {
                const input = document.getElementById(`${fieldName}Input`);
                if (input) {
                    input.value = modalState.formData[fieldName] || '';
                }
            });
        }
        
        function showContactModal() {
            const modal = document.getElementById('contactModal');
            const body = document.body;
            
            modal.classList.add('active');
            body.classList.add('modal-open');
            modalState.isOpen = true;
            
            // Focus first input
            setTimeout(() => {
                const firstInput = document.getElementById('nameInput');
                if (firstInput) firstInput.focus();
            }, 100);
        }
        
        function hideContactModal() {
            const modal = document.getElementById('contactModal');
            const body = document.body;
            
            if (modal) modal.classList.remove('active');
            body.classList.remove('modal-open');
            modalState.isOpen = false;
            
            // Clear form data
            modalState.formData = {};
        }
        
        function cancelContactModal() {
            hideContactModal();
            console.log('‚ùå Contact modal cancelled');
        }
        
        function saveContactModal() {
            // Validate required fields
            if (!modalState.formData.name || modalState.formData.name.trim() === '') {
                alert('Please enter a name');
                document.getElementById('nameInput').focus();
                return;
            }
            
            if (modalState.mode === 'edit') {
                saveEditedContact();
            } else {
                saveNewContact();
            }
            
            hideContactModal();
        }
        
        function saveEditedContact() {
            const contactId = modalState.currentContact.id;
            const updatedData = { ...modalState.formData };
            
            // Store the edit in teamState
            teamState.editedContacts[contactId] = updatedData;
            
            // Update the contact display
            updateContactDisplay(contactId, updatedData);
            
            console.log('‚úÖ Contact edited:', contactId, updatedData);
        }
        
        function saveNewContact() {
            const newContact = {
                id: 'new_' + Date.now(), // Temporary ID
                name: modalState.formData.name,
                roleTitle: modalState.formData.title,
                workEmail: modalState.formData.email,
                workPhone: modalState.formData.phone,
                dietaryRestrictions: modalState.formData.dietary,
                isNew: true
            };
            
            // Add to teamState
            teamState.newContacts.push(newContact);
            
            // Add to the contact list display
            addNewContactToList(newContact);
            
            console.log('‚úÖ New contact created:', newContact);
        }
        
        function updateContactDisplay(contactId, updatedData) {
            const contactElement = document.querySelector(`[data-contact-id="${contactId}"]`);
            if (!contactElement) return;

            // Update the display with new data
            const nameElement = contactElement.querySelector('.contact-name');
            const titleElement = contactElement.querySelector('.contact-title');
            const emailElement = contactElement.querySelector('.contact-email');
            const phoneElement = contactElement.querySelector('.contact-phone');
            const dietaryElement = contactElement.querySelector('.contact-dietary');

            if (nameElement) nameElement.textContent = updatedData.name;
            if (titleElement) titleElement.textContent = updatedData.title;
            if (emailElement) emailElement.textContent = updatedData.email;
            if (phoneElement) phoneElement.textContent = formatPhoneForDisplay(updatedData.phone);
            if (dietaryElement) dietaryElement.textContent = updatedData.dietary || '';
        }
        
        function addNewContactToList(newContact) {
            const teamList = document.getElementById('teamList');
            if (!teamList) return;
            
            const contactElement = createContactElement(newContact, -1);
            teamList.appendChild(contactElement);
            
            // Update scrollbar
            setTimeout(() => {
                if (window.updateScrollbar) {
                    window.updateScrollbar();
                }
            }, 100);
        }
        
        // Update the existing edit and add contact functions
        function editContact(contactId, index) {
            openEditContactModal(contactId, index);
        }
        
        function setupAddContactHandler() {
            const addContactSection = document.querySelector('.add-contact-section');
            if (addContactSection) {
                addContactSection.addEventListener('click', () => {
                    openNewContactModal();
                });
            }
        }

        function confirmDeleteContact() {
            if (!modalState.currentContact) return;

            const contactName = modalState.currentContact.name;
            const confirmMessage = `Are you sure you want to delete ${contactName}?`;

            if (confirm(confirmMessage)) {
                deleteContact();
            }
        }

        function deleteContact() {
            const contactId = modalState.currentContact.id;
            const contactName = modalState.currentContact.name;

            // Flag for deletion in teamState
            if (!teamState.deletedContacts) {
                teamState.deletedContacts = new Set();
            }
            teamState.deletedContacts.add(contactId);

            // Remove from UI
            const contactElement = document.querySelector(`[data-contact-id="${contactId}"]`);
            if (contactElement) {
                contactElement.remove();
            }

            // Remove from organizationContacts array
            const contactIndex = organizationContacts.findIndex(c => c.id === contactId);
            if (contactIndex !== -1) {
                organizationContacts.splice(contactIndex, 1);
            }

            // Remove from teamState if they were new or edited
            if (teamState.newContacts) {
                teamState.newContacts = teamState.newContacts.filter(c => c.id !== contactId);
            }
            if (teamState.editedContacts && teamState.editedContacts[contactId]) {
                delete teamState.editedContacts[contactId];
            }

            // Remove from attending list
            teamState.attendingContacts.delete(contactId);

            // If this was the primary contact, clear primary selection
            if (modalState.currentContact.isPrimaryContact) {
                organizationContacts.forEach(contact => {
                    contact.isPrimaryContact = false;
                });
            }

            console.log(`üóëÔ∏è Deleted contact: ${contactName}`);
            hideContactModal();

            // Update scrollbar
            setTimeout(() => {
                if (window.updateScrollbar) {
                    window.updateScrollbar();
                }
            }, 100);
        }
        // ===========================================
        // STEP 4: PRIMARY CONTACT SELECTION - COMPLETE SECTION
        // ===========================================
        
        let primaryContactState = {
            selectedContactId: null
        };
        
        function initializeStep4() {
            // First populate the list
            populatePrimaryContactList();
            
            // Then auto-select primary contact if one exists
            const primaryContact = organizationContacts.find(contact => contact.isPrimaryContact);
            if (primaryContact) {
                primaryContactState.selectedContactId = primaryContact.id;
                console.log(`üéØ Auto-selected primary contact: ${primaryContact.name}`);
                
                // Re-populate to show the selection
                setTimeout(() => {
                    populatePrimaryContactList();
                }, 50);
            }
            
            console.log('üöÄ Step 4 (Primary Contact) initialized!');
        }
        
        function populatePrimaryContactList() {
            const primaryContactList = document.getElementById('primaryContactList');
            if (!primaryContactList || !organizationContacts) return;
            
            primaryContactList.innerHTML = '';
        
            // COMBINE original contacts + newly created contacts from Step 3
            const allAvailableContacts = [
                ...organizationContacts, // Original contacts from API
                ...teamState.newContacts.map(newContact => ({
                    id: newContact.id,
                    name: newContact.name,
                    workEmail: newContact.workEmail,
                    workPhone: newContact.workPhone,
                    roleTitle: newContact.roleTitle,
                    isPrimaryContact: false,
                    isNew: true
                }))
            ];
            
            allAvailableContacts.forEach((contact, index) => {
                const contactElement = createPrimaryContactElement(contact, index);
                primaryContactList.appendChild(contactElement);
            });
            
            // Count primary contacts for debugging
            const primaryContactsCount = allAvailableContacts.filter(c => c.isPrimaryContact).length;
            console.log(`üëë Found ${primaryContactsCount} primary contacts`);
            
            console.log(`‚úÖ Returning ${allAvailableContacts.length} contacts for primary selection (${organizationContacts.length} original + ${teamState.newContacts.length} new)`);
        }
        
        function createPrimaryContactElement(contact, index) {
            const contactDiv = document.createElement('div');
            contactDiv.className = 'primary-contact-item';
            contactDiv.dataset.contactId = contact.id;
            contactDiv.dataset.index = index;
            
            const isSelected = primaryContactState.selectedContactId === contact.id;
            if (isSelected) {
                contactDiv.classList.add('selected');
            }
            
            // Get the contact data (check for edits from Step 3)
            const contactData = teamState.editedContacts[contact.id] || contact;
            
            // Format phone number for display
            const phone = contactData.workPhone || contact.workPhone || '';
            const formattedPhone = phone ? formatPhoneForDisplay(phone) : '';
            
            // Add visual indicators for existing primary contacts and new contacts
            const primaryIndicator = contact.isPrimaryContact ? ' üëë' : '';
            const newIndicator = contact.isNew ? ' (New)' : '';
            
            contactDiv.innerHTML = `
                <div class="primary-contact-radio" onclick="selectPrimaryContact('${contact.id}')">
                    <div class="radio-circle ${isSelected ? 'selected' : ''}"></div>
                </div>
                <div class="primary-contact-info">
                    <div class="primary-contact-name">${contactData.name || contact.name}${primaryIndicator}${newIndicator}</div>
                    <div class="primary-contact-title">${contactData.title || contactData.roleTitle || contact.roleTitle || ''}</div>
                    <div class="primary-contact-email">${contactData.email || contactData.workEmail || contact.workEmail || ''}</div>
                    <div class="primary-contact-phone">${formattedPhone}</div>
                </div>
            `;
            
            // Make the whole item clickable
            contactDiv.addEventListener('click', () => selectPrimaryContact(contact.id));
            
            return contactDiv;
        }
        
        function selectPrimaryContact(contactId) {
            // Update the state
            primaryContactState.selectedContactId = contactId;
            
            // Find contact name for logging
            const allContacts = [...organizationContacts, ...teamState.newContacts];
            const contact = allContacts.find(c => c.id === contactId);
            const contactData = teamState.editedContacts[contactId] || contact;
            const contactName = contactData?.name || contact?.name || 'Unknown';
            
            console.log(`üëë Selected primary contact: ${contactName} (${contactId})`);
            
            // Refresh the entire list to show the updated selection
            populatePrimaryContactList();
        }
        // ===========================================
        // STEP 5: PRODUCT CATALOGUE UPLOAD
        // ===========================================
        let catalogueState = {
            uploadedFile: null,
            uploadedUrl: null
        };
        
        function initializeStep5() {
            initializeCatalogueUpload();
            console.log('üöÄ Step 5 (Product Catalogue) initialized!');
        }
        
        function initializeCatalogueUpload() {
            const container = document.getElementById('catalogueUploadContainer');
            const fileInput = document.getElementById('catalogueFileInput');
        
            if (!container || !fileInput) return;
        
            // Click to select file
            container.addEventListener('click', () => fileInput.click());
        
            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleCatalogueFileSelection(e.target.files[0]);
                }
            });
        
            // Drag and drop
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                container.classList.add('dragover');
            });
        
            container.addEventListener('dragleave', () => {
                container.classList.remove('dragover');
            });
        
            container.addEventListener('drop', (e) => {
                e.preventDefault();
                container.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    handleCatalogueFileSelection(e.dataTransfer.files[0]);
                }
            });
        }
        
        function handleCatalogueFileSelection(file) {
            console.log('üìÑ File selected:', file.name, file.type, file.size);
            
            // Validate file type (only PDFs)
            if (file.type !== 'application/pdf') {
                showCatalogueError('Please select a PDF file only.');
                return;
            }
        
            // Validate file size (25MB max)
            const maxSize = 25 * 1024 * 1024; // 25MB
            if (file.size > maxSize) {
                showCatalogueError('File size exceeds 25MB limit. Please choose a smaller PDF file.');
                return;
            }
        
            console.log('‚úÖ Valid PDF file selected:', file.name);
            catalogueState.uploadedFile = file;
            uploadCatalogueToS3(file);
        }
        
        async function uploadCatalogueToS3(file) {
            console.log('üì§ Starting catalogue upload to S3...');
            
            const progressContainer = document.getElementById('catalogueUploadProgress');
            const progressFill = document.getElementById('catalogueUploadProgressFill');
            const container = document.getElementById('catalogueUploadContainer');
            const placeholder = document.getElementById('cataloguePlaceholder');
            const successSection = document.getElementById('catalogueSuccess');
            
            // Show progress
            progressContainer.style.display = 'block';
            
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress > 90) progress = 90;
                progressFill.style.width = progress + '%';
            }, 300);
        
            try {
                const organizationName = formState?.companyName || 'Demo Company';
                const token = new URLSearchParams(window.location.search).get('token') || 'demo-token';
                const base64 = await fileToBase64(file);
                
                // Consistent naming - always overwrites the previous catalogue
                const uploadData = {
                    files: [{
                        name: 'catalogue.pdf', // Always the same name
                        content: base64.split(',')[1],
                        type: file.type,
                        fieldName: 'catalogFile'
                    }],
                    organizationName: organizationName,
                    token: token
                };
        
                const response = await fetch(`${API_BASE}/upload-to-s3`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(uploadData)
                });
        
                if (!response.ok) throw new Error(`Upload failed: ${response.status}`);
        
                const result = await response.json();
                
                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressFill.style.width = '0%';
                    
                    // Show success state
                    placeholder.style.display = 'none';
                    successSection.style.display = 'flex';
                    container.classList.add('uploaded');
                    
                    // Update success text with original filename for user feedback
                    document.getElementById('successFilename').textContent = file.name;
                    
                }, 1000);
        
                // Store the uploaded file URL
                const catalogueUrl = result.uploadResults?.catalogueUrl;
                if (catalogueUrl) {
                    catalogueState.uploadedUrl = catalogueUrl;
                    console.log('‚úÖ Catalogue uploaded successfully:', catalogueUrl);
                } else {
                    throw new Error('No catalogue URL found in response');
                }
        
            } catch (error) {
                console.error('üí• Catalogue upload failed:', error);
                clearInterval(progressInterval);
                progressContainer.style.display = 'none';
                progressFill.style.width = '0%';
                showCatalogueError('Upload failed. Please try again.');
            }
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        
        function showCatalogueError(message) {
            const errorElement = document.getElementById('catalogueError');
            if (!errorElement) return;
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => errorElement.style.display = 'none', 5000);
        }

        function showUploadedImage(imageUrl) {
            const placeholder = document.getElementById('imagePlaceholder');
            const uploadedImage = document.getElementById('uploadedImage');
            const container = document.getElementById('imageUploadContainer');
            
            if (placeholder && uploadedImage && container) {
                placeholder.style.display = 'none';
                uploadedImage.src = imageUrl;
                uploadedImage.style.display = 'block';
                
                // Update overlay text for uploaded state
                const overlay = document.getElementById('imageOverlay');
                if (overlay) {
                    overlay.textContent = 'Click to change image';
                }
                
                console.log('üì∏ Image displayed successfully');
            }
        }

        function validateFinalSubmission() {
            const errors = [];
            
            // Validate required fields
            if (!formState.companyName) {
                errors.push('Company name is required');
            }
            
            if (!formState.category) {
                errors.push('Primary category is required');
            }
            
            // Validate at least one attending contact
            if (teamState.attendingContacts.size === 0) {
                errors.push('At least one team member must be attending the conference');
            }
            
            // Validate primary contact is selected
            if (!primaryContactState.selectedContactId) {
                errors.push('A primary contact must be selected');
            }
            
            if (errors.length > 0) {
                alert('Please fix the following issues:\n\n' + errors.join('\n'));
                return false;
            }
            
            return true;
        }
        
        async function finishWizard() {
           console.log('üéâ Wizard complete! Validating submission...');
           
           // Step 1: Validate
           if (!validateFinalSubmission()) {
               return;
           }
           
           // Step 2: Initialize step 6 and mark everything complete
           showStep(6);
           document.querySelectorAll('.step-item').forEach(item => {
               item.classList.remove('active');
               item.classList.add('completed');
           });
           
           // Step 3: Show uploading screen
           showUploadingState();
           
           // Step 4: Try all the upload APIs
           let hasErrors = false;
           const token = new URLSearchParams(window.location.search).get('token');
           
           try {
               // Process conference team
               console.log('üë• Processing conference team...');
               
               const contactOperations = {
                   create: teamState.newContacts || [],
                   update: Object.keys(teamState.editedContacts || {}).map(contactId => ({
                       originalId: contactId,
                       name: teamState.editedContacts[contactId].name,
                       workEmail: teamState.editedContacts[contactId].email,
                       workPhone: teamState.editedContacts[contactId].phone,
                       roleTitle: teamState.editedContacts[contactId].title
                   })),
                   delete: [],
                   conferenceTeam: Array.from(teamState.attendingContacts).map(contactId => ({
                       id: contactId,
                       attending: true,
                       isPrimary: contactId === primaryContactState.selectedContactId
                   }))
                };
                
                // ADD THIS DEBUG LOGGING:
                console.log('üîç DEBUG - teamState.attendingContacts:', teamState.attendingContacts);
                console.log('üîç DEBUG - primaryContactState.selectedContactId:', primaryContactState.selectedContactId);
                console.log('üîç DEBUG - contactOperations.conferenceTeam:', contactOperations.conferenceTeam);
               
               const teamResponse = await fetch(`${API_BASE}/save-conference-team`, {
                   method: 'POST',
                   headers: { 'Content-Type': 'application/json' },
                   body: JSON.stringify({
                       token: token,
                       contactOperations: contactOperations
                   })
               });
               
               if (!teamResponse.ok) {
                   const teamError = await teamResponse.json();
                   throw new Error(`Team processing failed: ${teamError.details || teamError.error}`);
               }
               
               console.log('‚úÖ Conference team processed');
               
               // Update organization data directly (no quarantine needed for membership renewal)
               console.log('üìù Updating organization data...');

               const organizationUpdates = {
                   institutionName: formState.companyName,
                   website: formState.website,
                   institutionSize: formState.institutionSize,
                   address: {
                       streetAddress: formState.streetAddress,
                       city: formState.city,
                       province: formState.province,
                       postalCode: formState.postalCode
                   }
               };

               const orgResponse = await fetch(`${API_BASE}/update-organization`, {
                   method: 'POST',
                   headers: { 'Content-Type': 'application/json' },
                   body: JSON.stringify({
                       token: token,
                       organizationUpdates: organizationUpdates
                   })
               });

               if (!orgResponse.ok) {
                   const orgError = await orgResponse.json();
                   throw new Error(`Organization update failed: ${orgError.details || orgError.error}`);
               }

               console.log('‚úÖ Organization data updated directly');
               
           } catch (error) {
               console.error('üí• API Error:', error);
               hasErrors = true;
           }
           
           // Step 5: Hide uploading and show results
           hideUploadingState();
           
           // Step 6: Show success or failure
           if (hasErrors) {
               console.log('‚ùå Showing failure screen');
               document.getElementById('errorContent').style.display = 'block';
               document.getElementById('successContent').style.display = 'none';
           } else {
               console.log('‚úÖ Showing success screen');
               document.getElementById('successContent').style.display = 'block';
               document.getElementById('errorContent').style.display = 'none';
           }
        }
        
        // State management functions
        function showUploadingState() {
            document.getElementById('uploadingState').classList.add('active');
            document.getElementById('wizardContent').style.display = 'none';
        }
        
        function hideUploadingState() {
            document.getElementById('uploadingState').classList.remove('active');
            document.getElementById('wizardContent').style.display = 'flex';
        }
    </script>

    <!-- Contact Modal (moved outside step sections) -->
    <div class="contact-modal" id="contactModal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Edit Contact</h3>
            </div>
            <form class="modal-form" id="modalForm">
                <div class="modal-field">
                    <div class="modal-field-border unfocused" id="nameBorder">
                        <div class="modal-field-label unfocused" id="nameLabel">Name</div>
                        <input type="text" class="modal-field-input" id="nameInput" placeholder="Enter full name">
                    </div>
                </div>

                <div class="modal-field">
                    <div class="modal-field-border unfocused" id="titleBorder">
                        <div class="modal-field-label unfocused" id="titleLabel">Job title</div>
                        <input type="text" class="modal-field-input" id="titleInput" placeholder="Enter job title">
                    </div>
                </div>

                <div class="modal-field">
                    <div class="modal-field-border unfocused" id="emailBorder">
                        <div class="modal-field-label unfocused" id="emailLabel">Email</div>
                        <input type="email" class="modal-field-input" id="emailInput" placeholder="Enter email address">
                    </div>
                </div>

                <div class="modal-field">
                    <div class="modal-field-border unfocused" id="phoneBorder">
                        <div class="modal-field-label unfocused" id="phoneLabel">Phone</div>
                        <input type="tel" class="modal-field-input" id="phoneInput" placeholder="Enter phone number">
                    </div>
                </div>

                <div class="modal-field">
                    <div class="modal-field-border unfocused" id="dietaryBorder">
                        <div class="modal-field-label unfocused" id="dietaryLabel">Dietary restrictions</div>
                        <textarea class="modal-field-input" id="dietaryInput" placeholder="Enter dietary restrictions" rows="2"></textarea>
                    </div>
                </div>
            </form>

            <div class="modal-actions">
                <button type="button" class="modal-btn delete" id="deleteContactBtn" onclick="confirmDeleteContact()" style="display: none;">DELETE</button>
                <div class="modal-actions-right">
                    <button type="button" class="modal-btn secondary" onclick="cancelContactModal()">Cancel</button>
                    <button type="button" class="modal-btn primary" onclick="saveContactModal()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Payment option functions for QB invoice redirect flow

        // Pay Now - redirect to QuickBooks invoice
        function payNowOnQuickBooks() {
            console.log('üí≥ Redirecting to QuickBooks payment...');

            if (window.qboInvoiceUrl) {
                console.log('üîó Opening QuickBooks invoice:', window.qboInvoiceUrl);
                window.location.href = window.qboInvoiceUrl;
            } else {
                console.error('‚ùå No QuickBooks invoice URL available');
                alert('Invoice not ready. Please try refreshing the page.');
            }
        }

        // Pay Later - show completion message
        function choosePayLater() {
            console.log('üìÑ User chose to pay later');

            // Show completion message
            const widgetContainer = document.getElementById('qbPaymentWidget');
            if (widgetContainer) {
                widgetContainer.innerHTML = `
                    <div class="form-container">
                        <div class="success">
                            <h3>‚úÖ Registration Complete!</h3>
                            <p>Your membership registration has been submitted and an invoice has been created.</p>
                            <p><strong>Invoice #:</strong> ${window.qboInvoiceResult?.qboInvoiceNumber || 'Pending'}</p>
                            <p>You can pay this invoice later by logging into your QuickBooks account or waiting for the emailed invoice.</p>

                            <button onclick="window.location.reload()" class="next-btn" style="margin-top: 20px;">
                                Start New Registration
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Show processing message while Notion sync happens in background
        function showProcessingMessage() {
            // Make it full screen and prominent
            const body = document.body;

            // Create overlay
            const overlay = document.createElement('div');
            overlay.id = 'uploadingOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(255, 255, 255, 0.95);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            overlay.innerHTML = `
                <div style="text-align: center; max-width: 500px; padding: 40px;">
                    <div style="width: 60px; height: 60px; border: 4px solid #ba003b; border-top: 4px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 30px;"></div>
                    <h2 style="color: #333; margin-bottom: 20px; font-family: 'davis-sans', sans-serif;">üöÄ Uploading Your Registration...</h2>
                    <p style="color: #666; font-size: 18px; line-height: 1.6; margin-bottom: 20px;">
                        <strong>Your QuickBooks invoice is ready!</strong><br>
                        Check your new tab to complete payment.
                    </p>
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 16px; border-radius: 8px; color: #856404;">
                        <strong>‚ö†Ô∏è Please don't close this page!</strong><br>
                        We're saving your information to our system. This will complete automatically in a few moments.
                    </div>
                </div>
            `;

            body.appendChild(overlay);
        }

        // Background Notion sync (async, doesn't block)
        async function backgroundNotionSync() {
            try {
                console.log('üöÄ Starting background Notion sync...');

                // Call the existing sync function
                await syncMembershipRenewal();

                console.log('‚úÖ Background Notion sync completed');
                showCompletionMessage();

            } catch (error) {
                console.error('‚ùå Background Notion sync failed:', error);
                showCompletionMessage(true); // Show with error message
            }
        }

        // Show final "thanks" completion message
        function showCompletionMessage(hasError = false) {
            // Remove the uploading overlay
            const overlay = document.getElementById('uploadingOverlay');
            if (overlay) {
                overlay.remove();
            }

            // Show step 6 (the actual success/completion step)
            showStep(6);

            // Mark all previous steps as completed
            document.querySelectorAll('.step-item').forEach((item, index) => {
                item.classList.remove('active');
                if (index < 5) { // Mark steps 1-4 and 5 as completed (steps 0-4 in 0-based index)
                    item.classList.add('completed');
                }
            });

            // Show appropriate content based on whether there was an error
            if (hasError) {
                document.getElementById('errorContent').style.display = 'block';
                document.getElementById('successContent').style.display = 'none';
            } else {
                document.getElementById('successContent').style.display = 'block';
                document.getElementById('errorContent').style.display = 'none';
            }

        }
    </script>

</body>
</html>
